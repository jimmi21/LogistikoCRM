{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
<style>
    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        text-align: center;
    }

    .stat-number {
        font-size: 32px;
        font-weight: bold;
        margin: 10px 0;
    }

    .stat-label {
        color: #666;
        font-size: 14px;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 600px;
        border-radius: 12px;
    }
</style>
{% endblock %}

{% block content %}
<div style="margin-bottom: 20px;">
    <a href="/accounting/dashboard/" style="color: #667eea; text-decoration: none; font-weight: 600;">â† Î•Ï€Î¹ÏƒÏ„ÏÎ¿Ï†Î® ÏƒÏ„Î¿ Dashboard</a>
</div>

<!-- Client Header -->
<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 12px; color: white; margin-bottom: 30px;">
    <h1 style="margin: 0 0 10px 0; font-size: 28px;">{{ client.eponimia }}</h1>
    <div style="display: flex; gap: 20px; font-size: 14px;">
        <div>ğŸ“‹ Î‘Î¦Îœ: {{ client.afm }}</div>
        <div>ğŸ¢ Î”ÎŸÎ¥: {{ client.doy }}</div>
        <div>ğŸ“§ {{ client.email|default:"â€”" }}</div>
        <div>ğŸ“ {{ client.kinito_tilefono|default:"â€”" }}</div>
    </div>
</div>

<!-- Stats Cards -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
    <div class="stat-card" style="border-top: 4px solid #667eea;">
        <div class="stat-label">Î£ÏÎ½Î¿Î»Î¿ Î¥Ï€Î¿Ï‡ÏÎµÏÏƒÎµÏ‰Î½</div>
        <div class="stat-number" style="color: #667eea;">{{ obligations.count }}</div>
    </div>

    <div class="stat-card" style="border-top: 4px solid #ffc107;">
        <div class="stat-label">Î•ÎºÎºÏÎµÎ¼ÎµÎ¯Ï‚</div>
        <div class="stat-number" style="color: #ffc107;">{{ pending_count|default:0 }}</div>
    </div>

    <div class="stat-card" style="border-top: 4px solid #28a745;">
        <div class="stat-label">ÎŸÎ»Î¿ÎºÎ»Î·ÏÏ‰Î¼Î­Î½ÎµÏ‚</div>
        <div class="stat-number" style="color: #28a745;">{{ completed_count|default:0 }}</div>
    </div>

    <div class="stat-card" style="border-top: 4px solid #17a2b8;">
        <div class="stat-label">ÎˆÎ³Î³ÏÎ±Ï†Î±</div>
        <div class="stat-number" style="color: #17a2b8;">{{ documents.count }}</div>
    </div>
</div>

<!-- Documents Section -->
<div style="background: white; padding: 25px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0; color: #333;">ğŸ“ ÎˆÎ³Î³ÏÎ±Ï†Î± Î ÎµÎ»Î¬Ï„Î·</h3>
        <button onclick="openUploadModal()"
                style="margin-left: auto; background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
            â• Î‘Î½Î­Î²Î±ÏƒÎ¼Î± Î•Î³Î³ÏÎ¬Ï†Î¿Ï…
        </button>
    </div>

    {% if documents %}
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                <th style="padding: 12px; text-align: left;">Î‘ÏÏ‡ÎµÎ¯Î¿</th>
                <th style="padding: 12px; text-align: left;">Î¤ÏÏ€Î¿Ï‚</th>
                <th style="padding: 12px; text-align: left;">Î¥Ï€Î¿Ï‡ÏÎ­Ï‰ÏƒÎ·</th>
                <th style="padding: 12px; text-align: left;">Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±</th>
                <th style="padding: 12px; text-align: center;">Î•Î½Î­ÏÎ³ÎµÎ¹ÎµÏ‚</th>
            </tr>
        </thead>
        <tbody>
            {% for doc in documents %}
            <tr style="border-bottom: 1px solid #e9ecef;">
                <td style="padding: 12px;">
                    <div style="font-weight: 500;">{{ doc.filename }}</div>
                    {% if doc.description %}
                    <div style="font-size: 12px; color: #6c757d;">{{ doc.description }}</div>
                    {% endif %}
                </td>
                <td style="padding: 12px;">
                    <span style="background: #e7f5ff; color: #0066cc; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">
                        {{ doc.file_type|upper }}
                    </span>
                </td>
                <td style="padding: 12px;">
                    {{ doc.obligation.obligation_type.name|default:"-" }}
                </td>
                <td style="padding: 12px;">
                    {{ doc.uploaded_at|date:"d/m/Y H:i" }}
                </td>
                <td style="padding: 12px; text-align: center;">
                    <a href="{{ doc.file.url }}" download
                       style="background: #17a2b8; color: white; text-decoration: none; padding: 6px 12px; border-radius: 4px; font-size: 13px;">
                        â¬‡ï¸ Download
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="text-align: center; color: #6c757d; padding: 40px;">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î­Î³Î³ÏÎ±Ï†Î±</p>
    {% endif %}
</div>

<!-- Upcoming Obligations -->
<div style="background: white; padding: 25px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
    <h3 style="margin: 0 0 20px 0; color: #333;">ğŸ“… Î•Ï€ÏŒÎ¼ÎµÎ½ÎµÏ‚ Î¥Ï€Î¿Ï‡ÏÎµÏÏƒÎµÎ¹Ï‚ (30 Î¼Î­ÏÎµÏ‚)</h3>

    {% if upcoming %}
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                <th style="padding: 12px; text-align: left;">Î ÏÎ¿Î¸ÎµÏƒÎ¼Î¯Î±</th>
                <th style="padding: 12px; text-align: left;">Î¥Ï€Î¿Ï‡ÏÎ­Ï‰ÏƒÎ·</th>
                <th style="padding: 12px; text-align: center;">Î•Î½Î­ÏÎ³ÎµÎ¹ÎµÏ‚</th>
            </tr>
        </thead>
        <tbody>
            {% for obl in upcoming %}
            <tr style="border-bottom: 1px solid #e9ecef;">
                <td style="padding: 12px;">
                    <div style="font-weight: 600;">{{ obl.deadline|date:"d/m/Y" }}</div>
                    <div style="font-size: 12px; color: #6c757d;">{{ obl.deadline|date:"l" }}</div>
                </td>
                <td style="padding: 12px;">
                    <div style="font-weight: 500;">{{ obl.obligation_type.name }}</div>
                </td>
                <td style="padding: 12px; text-align: center;">
                    <button onclick="quickComplete({{ obl.id }})"
                            style="background: #28a745; color: white; border: none; padding: 6px 15px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">
                        âœ“ ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="text-align: center; color: #6c757d; padding: 40px;">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎµÏ€ÎµÏÏ‡ÏŒÎ¼ÎµÎ½ÎµÏ‚ Ï…Ï€Î¿Ï‡ÏÎµÏÏƒÎµÎ¹Ï‚</p>
    {% endif %}
</div>

<!-- Recent Completed -->
<div style="background: white; padding: 25px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
    <h3 style="margin: 0 0 20px 0; color: #333;">âœ… Î ÏÏŒÏƒÏ†Î±Ï„Î± ÎŸÎ»Î¿ÎºÎ»Î·ÏÏ‰Î¼Î­Î½ÎµÏ‚ (30 Î¼Î­ÏÎµÏ‚)</h3>

    {% if recent_completed %}
    <table style="width: 100%; border-collapse: collapse;">
        <tbody>
            {% for obl in recent_completed %}
            <tr style="border-bottom: 1px solid #e9ecef;">
                <td style="padding: 12px;">
                    <div style="font-weight: 600; color: #28a745;">{{ obl.completed_date|date:"d/m/Y" }}</div>
                </td>
                <td style="padding: 12px;">
                    <div style="font-weight: 500;">{{ obl.obligation_type.name }}</div>
                    {% if obl.notes %}
                    <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">
                        ğŸ’¬ {{ obl.notes|truncatewords:10 }}
                    </div>
                    {% endif %}
                </td>
                <td style="padding: 12px; text-align: right;">
                    <div style="display: flex; gap: 10px; justify-content: flex-end; align-items: center;">
                        {% if obl.time_spent %}
                        <span style="color: #6c757d; font-size: 14px;">{{ obl.time_spent }}h</span>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="text-align: center; color: #6c757d; padding: 40px;">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Ï€ÏÏŒÏƒÏ†Î±Ï„ÎµÏ‚ Î¿Î»Î¿ÎºÎ»Î·ÏÏ‰Î¼Î­Î½ÎµÏ‚</p>
    {% endif %}
</div>

<!-- Upload Modal -->
<div id="uploadModal" class="modal">
    <div class="modal-content">
        <h3 style="margin: 0 0 20px 0;">ğŸ“¤ Î‘Î½Î­Î²Î±ÏƒÎ¼Î± Î•Î³Î³ÏÎ¬Ï†Î¿Ï…</h3>

        <form id="uploadForm" method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Î‘ÏÏ‡ÎµÎ¯Î¿:</label>
                <input type="file" name="file" required
                       style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px;">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Î£Ï‡ÎµÏ„Î¹ÎºÎ® Î¥Ï€Î¿Ï‡ÏÎ­Ï‰ÏƒÎ· (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ):</label>
                <select name="obligation" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px;">
                    <option value="">-- Î•Ï€Î¹Î»Î­Î¾Ï„Îµ --</option>
                    {% for obl in obligations %}
                    <option value="{{ obl.id }}">{{ obl.obligation_type.name }} ({{ obl.month }}/{{ obl.year }})</option>
                    {% endfor %}
                </select>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Î ÎµÏÎ¹Î³ÏÎ±Ï†Î®:</label>
                <textarea name="description" rows="3"
                          style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px;"
                          placeholder="Ï€.Ï‡. Î¤Î¹Î¼Î¿Î»ÏŒÎ³Î¹Î¿ Î±Î³Î¿ÏÎ¬Ï‚..."></textarea>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" onclick="closeUploadModal()"
                        style="background: #f5f5f5; color: #666; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                    Î‘ÎºÏÏÏ‰ÏƒÎ·
                </button>
                <button type="submit"
                        style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                    ğŸ“¤ Î‘Î½Î­Î²Î±ÏƒÎ¼Î±
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Modal functions
function openUploadModal() {
    document.getElementById('uploadModal').style.display = 'block';
}

function closeUploadModal() {
    document.getElementById('uploadModal').style.display = 'none';
}

// Upload form
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    formData.append('client', {{ client.id }});

    fetch('/accounting/api/documents/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.id) {
            alert('âœ… Î¤Î¿ Î­Î³Î³ÏÎ±Ï†Î¿ Î±Î½Î­Î²Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚!');
            location.reload();
        } else {
            alert('âŒ Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î¿ Î±Î½Î­Î²Î±ÏƒÎ¼Î±');
        }
    })
    .catch(error => {
        alert('âŒ Î£Ï†Î¬Î»Î¼Î±: ' + error);
    });
});

// CSRF token getter
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Quick complete function
function quickComplete(obligationId) {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); display: flex; align-items: center;
        justify-content: center; z-index: 9999;
    `;

    modal.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
            <h3 style="margin: 0 0 20px 0; color: #333;">âœ“ ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ· Î¥Ï€Î¿Ï‡ÏÎ­Ï‰ÏƒÎ·Ï‚</h3>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">â±ï¸ ÎÏÎµÏ‚:</label>
                <input type="number" id="time-spent" step="0.5" min="0" value="0" placeholder="Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ"
                       style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 15px;">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">ğŸ“ Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚:</label>
                <textarea id="notes" rows="3"
                          style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 15px;"
                          placeholder="Ï€.Ï‡. Î¥Ï€Î¿Î²Î»Î®Î¸Î·ÎºÎµ Î·Î»ÎµÎºÏ„ÏÎ¿Î½Î¹ÎºÎ¬..."></textarea>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="closeModal()"
                        style="background: #f5f5f5; color: #666; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                    Î‘ÎºÏÏÏ‰ÏƒÎ·
                </button>
                <button onclick="submitComplete(${obligationId})"
                        style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                    âœ“ ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    setTimeout(() => document.getElementById('time-spent').focus(), 100);

    modal.addEventListener('click', function(e) {
        if (e.target === modal) closeModal();
    });
}

function closeModal() {
    const modal = document.querySelector('[style*="z-index: 9999"]');
    if (modal) modal.remove();
}

function submitComplete(obligationId) {
    const timeSpent = document.getElementById('time-spent').value;
    const notes = document.getElementById('notes').value;

    const btn = event.target;
    btn.textContent = 'â³ Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·...';
    btn.disabled = true;

    fetch(`/accounting/quick-complete/${obligationId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            time_spent: timeSpent || 0,
            notes: notes
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeModal();
            alert('âœ… ' + data.message);
            location.reload();
        } else {
            alert('âŒ ' + data.message);
            btn.textContent = 'âœ“ ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·';
            btn.disabled = false;
        }
    })
    .catch(error => {
        alert('âŒ Î£Ï†Î¬Î»Î¼Î±: ' + error);
        btn.textContent = 'âœ“ ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·';
        btn.disabled = false;
    });
}

// Close modal on click outside
window.onclick = function(event) {
    if (event.target == document.getElementById('uploadModal')) {
        closeUploadModal();
    }
}
</script>
{% endblock %}