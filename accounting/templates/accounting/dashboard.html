{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
<link rel="stylesheet" href="{% static 'accounting/css/dashboard.css' %}">
<style>
/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    align-items: center;
    justify-content: center;
}

.modal-content {
    background-color: white;
    border-radius: 10px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    margin: 0;
    color: #333;
}

.modal-close {
    background: none;
    border: none;
    font-size: 28px;
    cursor: pointer;
    color: #999;
}

.modal-close:hover {
    color: #333;
}

.modal-body {
    padding: 20px;
}

.modal-footer {
    padding: 20px;
    border-top: 1px solid #eee;
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
}

.form-label .icon {
    margin-right: 5px;
}

.file-input, .form-select, .form-input, .form-textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
}

.help-text {
    display: block;
    margin-top: 5px;
    font-size: 12px;
    color: #666;
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    font-weight: 600;
    color: #333;
}

.form-checkbox {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

/* Notification Styles */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000;
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    padding: 15px 20px;
    min-width: 300px;
    opacity: 0;
    transform: translateX(400px);
    transition: all 0.3s ease;
}

.notification.show {
    opacity: 1;
    transform: translateX(0);
}

.notification-success {
    border-left: 4px solid #10b981;
}

.notification-error {
    border-left: 4px solid #ef4444;
}

.notification-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.notification-close {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    margin-left: 15px;
}

/* Wizard Modal Styles */
.wizard-modal .modal-content {
    max-width: 700px;
    width: 95%;
}

.wizard-header {
    padding: 20px;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px 10px 0 0;
}

.wizard-header h2 {
    margin: 0;
    font-size: 1.3rem;
}

.wizard-progress-text {
    font-size: 0.9rem;
    opacity: 0.9;
}

.wizard-body {
    padding: 25px;
    min-height: 350px;
}

.wizard-obligation-info {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}

.wizard-obligation-info .info-row {
    display: flex;
    margin-bottom: 10px;
    align-items: center;
}

.wizard-obligation-info .info-label {
    font-weight: 600;
    color: #6c757d;
    width: 120px;
    flex-shrink: 0;
}

.wizard-obligation-info .info-value {
    color: #333;
    font-weight: 500;
}

.wizard-obligation-info .client-name {
    font-size: 1.2rem;
    color: #333;
    font-weight: 600;
}

.wizard-obligation-info .obligation-type {
    display: inline-block;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.9rem;
}

.wizard-file-upload {
    margin: 20px 0;
}

.wizard-dropzone {
    border: 2px dashed #dee2e6;
    border-radius: 10px;
    padding: 30px;
    text-align: center;
    background: #f8f9fa;
    cursor: pointer;
    transition: all 0.3s ease;
}

.wizard-dropzone:hover {
    border-color: #667eea;
    background: #f0f4ff;
}

.wizard-dropzone.dragging {
    border-color: #667eea;
    background: #e8edff;
}

.wizard-dropzone-icon {
    font-size: 2.5rem;
    margin-bottom: 10px;
}

.wizard-dropzone-text {
    color: #6c757d;
    margin-bottom: 10px;
}

.wizard-dropzone-btn {
    background: #667eea;
    color: white;
    border: none;
    padding: 8px 20px;
    border-radius: 5px;
    cursor: pointer;
}

.wizard-file-preview {
    display: flex;
    align-items: center;
    background: #e8f5e9;
    padding: 10px 15px;
    border-radius: 8px;
    margin-top: 10px;
}

.wizard-file-preview .file-icon {
    font-size: 1.5rem;
    margin-right: 10px;
}

.wizard-file-preview .file-name {
    flex-grow: 1;
    font-weight: 500;
}

.wizard-file-preview .file-remove {
    background: none;
    border: none;
    color: #dc3545;
    cursor: pointer;
    font-size: 1.2rem;
}

.wizard-options {
    margin: 20px 0;
}

.wizard-checkbox-group {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
}

.wizard-checkbox-label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    padding: 10px 15px;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    transition: all 0.2s ease;
}

.wizard-checkbox-label:hover {
    background: #f8f9fa;
}

.wizard-checkbox-label.checked {
    background: #e8f5e9;
    border-color: #28a745;
}

.wizard-checkbox-label.skip-checked {
    background: #fff3cd;
    border-color: #ffc107;
}

.wizard-checkbox {
    width: 20px;
    height: 20px;
}

.wizard-footer {
    padding: 20px;
    border-top: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.wizard-nav-btns {
    display: flex;
    gap: 10px;
}

.wizard-progress-dots {
    display: flex;
    gap: 6px;
    justify-content: center;
}

.wizard-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #dee2e6;
    transition: all 0.3s ease;
}

.wizard-dot.active {
    background: #667eea;
    transform: scale(1.2);
}

.wizard-dot.completed {
    background: #28a745;
}

.wizard-dot.skipped {
    background: #ffc107;
}

.btn-wizard-prev, .btn-wizard-next {
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 5px;
}

.btn-wizard-prev {
    background: #f8f9fa;
    color: #333;
    border: 1px solid #dee2e6;
}

.btn-wizard-next {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-wizard-finish {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    padding: 12px 25px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 600;
}

.btn-wizard-prev:disabled, .btn-wizard-next:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.wizard-summary {
    max-height: 300px;
    overflow-y: auto;
}

.wizard-summary-item {
    display: flex;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid #eee;
}

.wizard-summary-item:last-child {
    border-bottom: none;
}

.wizard-summary-item .summary-icon {
    font-size: 1.2rem;
    margin-right: 10px;
}

.wizard-summary-item.will-complete {
    background: #e8f5e9;
}

.wizard-summary-item.will-skip {
    background: #fff3cd;
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-wrapper">

    <!-- ğŸšª DOOR WIDGET - TOP RIGHT -->
    <div class="door-widget-container">
        {% include 'accounting/door_widget.html' %}
    </div>

    <!-- QUICK NAVIGATION BAR -->
    <nav class="quick-nav-bar">
        <div class="nav-breadcrumb">
            <a href="{% url 'admin:index' %}">
                <span>ğŸ </span>
                <span>Admin</span>
            </a>
            <span class="separator">â€º</span>
            <span class="current">ğŸ“Š Dashboard</span>
        </div>
        <div class="nav-quick-actions">
            <a href="{% url 'admin:index' %}" class="nav-btn nav-btn-admin">
                <span>â†</span>
                <span>Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ·</span>
            </a>
            <a href="{% url 'admin:accounting_monthlyobligation_changelist' %}" class="nav-btn nav-btn-primary">
                <span>ğŸ“‹</span>
                <span>Î¥Ï€Î¿Ï‡ÏÎµÏÏƒÎµÎ¹Ï‚</span>
            </a>
            <a href="{% url 'admin:accounting_clientprofile_changelist' %}" class="nav-btn nav-btn-secondary">
                <span>ğŸ‘¥</span>
                <span>Î ÎµÎ»Î¬Ï„ÎµÏ‚</span>
            </a>
            <a href="{% url 'accounting:calendar' %}" class="nav-btn nav-btn-info">
                <span>ğŸ“…</span>
                <span>Î—Î¼ÎµÏÎ¿Î»ÏŒÎ³Î¹Î¿</span>
            </a>
            <a href="{% url 'admin:accounting_monthlyobligation_add' %}" class="nav-btn nav-btn-success">
                <span>â•</span>
                <span>ÎÎ­Î± Î¥Ï€Î¿Ï‡ÏÎ­Ï‰ÏƒÎ·</span>
            </a>
        </div>
    </nav>

    <!-- PAGE HEADER WITH NAVIGATION -->
    <header class="dashboard-header">
        <div class="header-wrapper">
            <div class="header-left">
                <div class="header-icon">ğŸ“Š</div>
                <div class="header-content">
                    <h1 class="page-title">Dashboard - Î•Ï€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ·</h1>
                    <p class="page-subtitle">Î ÏÎ¿Î·Î³Î¼Î­Î½Î· Î´Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Ï…Ï€Î¿Ï‡ÏÎµÏÏƒÎµÏ‰Î½ Î¼Îµ Î­Î¾Ï…Ï€Î½Î· Î±Î½Î¬Î»Ï…ÏƒÎ·</p>
                </div>
            </div>
            <div class="header-right">
                <a href="{% url 'accounting:reports' %}" class="btn btn-gradient btn-lg">
                    <span class="icon">ğŸ“ˆ</span>
                    <span>Reports & Analytics</span>
                </a>
            </div>
        </div>

        <!-- STATS CARDS -->
        <div class="stats-grid">
            <div class="stat-card stat-pending">
                <div class="stat-icon">â³</div>
                <div class="stat-content">
                    <div class="stat-label">Î•ÎºÎºÏÎµÎ¼ÎµÎ¯Ï‚</div>
                    <div class="stat-value">{{ pending }}</div>
                </div>
            </div>
            <div class="stat-card stat-completed">
                <div class="stat-icon">âœ…</div>
                <div class="stat-content">
                    <div class="stat-label">ÎŸÎ»Î¿ÎºÎ»Î·ÏÏ‰Î¼Î­Î½ÎµÏ‚</div>
                    <div class="stat-value">{{ completed }}</div>
                </div>
            </div>
            <div class="stat-card stat-overdue">
                <div class="stat-icon">âš ï¸</div>
                <div class="stat-content">
                    <div class="stat-label">ÎšÎ±Î¸Ï…ÏƒÏ„ÎµÏÎ·Î¼Î­Î½ÎµÏ‚</div>
                    <div class="stat-value">{{ overdue }}</div>
                </div>
            </div>
            <div class="stat-card stat-total">
                <div class="stat-icon">ğŸ‘¥</div>
                <div class="stat-content">
                    <div class="stat-label">Î£ÏÎ½Î¿Î»Î¿ Î ÎµÎ»Î±Ï„ÏÎ½</div>
                    <div class="stat-value">{{ total_clients }}</div>
                </div>
            </div>
        </div>
    </header>

    <!-- FILTERS SECTION WITH ANIMATIONS -->
    <section class="filters-section">
        <div class="filters-badge" id="active-filters-count" style="display: none;">0</div>

        <div class="filters-header">
            <div class="filters-title-group">
                <h2 class="filters-title">
                    <span class="filters-icon">ğŸ”</span>
                    Î¦Î¯Î»Ï„ÏÎ± & Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·
                </h2>
                <div class="filters-subtitle">Î‘Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î±: <strong>{{ upcoming_count }}</strong></div>
            </div>
            <button type="button" id="filters-toggle" class="btn btn-icon" title="Expand/Collapse filters">
                <span>â–¼</span>
            </button>
        </div>

        <form method="get" id="filter-form" class="filters-form">
            <div class="filters-content">

                <!-- MAIN FILTERS GRID -->
                <div class="filters-grid">
                    <!-- Status -->
                    <div class="filter-group">
                        <label for="filter-status" class="filter-label">
                            <span class="filter-icon">ğŸ“Š</span>
                            ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·
                        </label>
                        <select id="filter-status" name="status" class="filter-select" data-filter="status">
                            <option value="">-- ÎŒÎ»ÎµÏ‚ --</option>
                            <option value="pending" {% if filter_status == 'pending' %}selected{% endif %}>â³ Î•ÎºÎºÏÎµÎ¼ÎµÎ¯Ï‚</option>
                            <option value="completed" {% if filter_status == 'completed' %}selected{% endif %}>âœ… ÎŸÎ»Î¿ÎºÎ»Î·ÏÏ‰Î¼Î­Î½ÎµÏ‚</option>
                            <option value="overdue" {% if filter_status == 'overdue' %}selected{% endif %}>âš ï¸ ÎšÎ±Î¸Ï…ÏƒÏ„ÎµÏÎ·Î¼Î­Î½ÎµÏ‚</option>
                        </select>
                    </div>

                    <!-- Client -->
                    <div class="filter-group">
                        <label for="filter-client" class="filter-label">
                            <span class="filter-icon">ğŸ‘¤</span>
                            Î ÎµÎ»Î¬Ï„Î·Ï‚
                        </label>
                        <select id="filter-client" name="client" class="filter-select" data-filter="client">
                            <option value="">-- ÎŒÎ»Î¿Î¹ Î¿Î¹ Ï€ÎµÎ»Î¬Ï„ÎµÏ‚ --</option>
                            {% for client in all_clients %}
                            <option value="{{ client.id }}" {% if filter_client == client.id|stringformat:"s" %}selected{% endif %}>
                                {{ client.eponimia }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Type -->
                    <div class="filter-group">
                        <label for="filter-type" class="filter-label">
                            <span class="filter-icon">ğŸ“‹</span>
                            Î¤ÏÏ€Î¿Ï‚ Î¥Ï€Î¿Ï‡ÏÎ­Ï‰ÏƒÎ·Ï‚
                        </label>
                        <select id="filter-type" name="type" class="filter-select" data-filter="type">
                            <option value="">-- ÎŒÎ»Î¿Î¹ Î¿Î¹ Ï„ÏÏ€Î¿Î¹ --</option>
                            {% for type in all_types %}
                            <option value="{{ type.id }}" {% if filter_type == type.id|stringformat:"s" %}selected{% endif %}>
                                {{ type.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Date Range -->
                    <div class="filter-group">
                        <label for="filter-date-from" class="filter-label">
                            <span class="filter-icon">ğŸ“…</span>
                            Î ÎµÏÎ¯Î¿Î´Î¿Ï‚
                        </label>
                        <div class="date-range-inputs">
                            <input type="date" id="filter-date-from" name="date_from"
                                   class="date-input" placeholder="Î‘Ï€ÏŒ" value="{{ date_from }}">
                            <span class="date-separator">â†’</span>
                            <input type="date" id="filter-date-to" name="date_to"
                                   class="date-input" placeholder="ÎˆÏ‰Ï‚" value="{{ date_to }}">
                        </div>
                    </div>

                    <!-- Sort -->
                    <div class="filter-group">
                        <label for="filter-sort" class="filter-label">
                            <span class="filter-icon">ğŸ”„</span>
                            Î¤Î±Î¾Î¹Î½ÏŒÎ¼Î·ÏƒÎ·
                        </label>
                        <select id="filter-sort" name="sort" class="filter-select">
                            <option value="deadline" {% if sort_by == 'deadline' %}selected{% endif %}>Î ÏÎ¿Î¸ÎµÏƒÎ¼Î¯Î± (Ï€ÏÏÏ„Î± ÎºÎ¿Î½Ï„Î¹Î½Î­Ï‚)</option>
                            <option value="client" {% if sort_by == 'client' %}selected{% endif %}>Î ÎµÎ»Î¬Ï„Î·Ï‚ (A-Z)</option>
                            <option value="type" {% if sort_by == 'type' %}selected{% endif %}>Î¤ÏÏ€Î¿Ï‚</option>
                            <option value="status" {% if sort_by == 'status' %}selected{% endif %}>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</option>
                        </select>
                    </div>
                </div>

                <!-- ACTIVE FILTERS DISPLAY -->
                <div id="active-filters-display" class="active-filters-display" style="display: none;">
                    <span class="active-label">Î•Î½ÎµÏÎ³Î¬ Ï†Î¯Î»Ï„ÏÎ±:</span>
                    <div id="active-filters-list" class="active-filters-list"></div>
                </div>

                <!-- FILTER ACTIONS -->
                <div class="filter-actions">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <span class="icon">ğŸ”</span>
                        <span>Î•Ï†Î±ÏÎ¼Î¿Î³Î® Î¦Î¯Î»Ï„ÏÏ‰Î½</span>
                    </button>
                    <button type="button" onclick="clearFilters()" class="btn btn-secondary">
                        <span class="icon">âœ–ï¸</span>
                        <span>ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚</span>
                    </button>
                    <button type="button" id="filter-preset-today" class="btn btn-outline">Î£Î®Î¼ÎµÏÎ±</button>
                    <button type="button" id="filter-preset-week" class="btn btn-outline">Î‘Ï…Ï„Î® Ï„Î·Î½ ÎµÎ²Î´Î¿Î¼Î¬Î´Î±</button>
                    <button type="button" id="filter-preset-month" class="btn btn-outline">Î‘Ï…Ï„ÏŒ Ï„Î¿ Î¼Î®Î½Î±</button>
                </div>
            </div>
        </form>
    </section>

    <!-- BULK ACTIONS BAR WITH ANIMATIONS -->
    <div id="bulk-actions-bar" class="bulk-actions-bar" style="display: none;">
        <div class="bulk-info">
            <span class="bulk-count">
                <span class="icon">âœ“</span>
                <span id="selected-count">0</span>
                <span class="plural">Ï…Ï€Î¿Ï‡ÏÎµÏÏƒÎµÎ¹Ï‚</span>
            </span>
        </div>

        <div class="bulk-actions-main">
            <div class="bulk-section">
                <h4 class="bulk-section-title">Î•Ï€Î¹Î»Î¿Î³Î®</h4>
                <div class="bulk-buttons">
                    <button type="button" onclick="selectAll()" class="btn btn-small btn-outline">âœ“ ÎŒÎ»ÎµÏ‚</button>
                    <button type="button" onclick="deselectAll()" class="btn btn-small btn-outline">âœ— ÎšÎ±Î¼Î¯Î±</button>
                </div>
            </div>

            <div class="bulk-section">
                <h4 class="bulk-section-title">Î•Î½Î­ÏÎ³ÎµÎ¹ÎµÏ‚</h4>
                <div class="bulk-buttons">
                    <button type="button" onclick="bulkComplete()" class="btn btn-small btn-success" title="Bulk complete with optional file upload">
                        <span class="icon">âœ“</span>
                        <span>ÎœÎ±Î¶Î¹ÎºÎ® ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·</span>
                    </button>
                    <button type="button" onclick="bulkEmail()" class="btn btn-small btn-info">
                        <span class="icon">ğŸ“§</span>
                        <span>Email</span>
                    </button>
                    <button type="button" onclick="bulkExport()" class="btn btn-small btn-primary">
                        <span class="icon">ğŸ“¥</span>
                        <span>Export</span>
                    </button>
                    <button type="button" onclick="bulkDelete()" class="btn btn-small btn-danger" title="Requires confirmation">
                        <span class="icon">ğŸ—‘ï¸</span>
                        <span>Î”Î¹Î±Î³ÏÎ±Ï†Î®</span>
                    </button>
                </div>
            </div>
        </div>

        <button type="button" onclick="closeBulkBar()" class="btn btn-icon btn-ghost" title="Close bulk actions">
            <span class="icon">Ã—</span>
        </button>
    </div>

    <!-- RESULTS TABLE WITH ADVANCED FEATURES -->
    <section class="results-section">
        <div class="results-header">
            <div class="results-title-group">
                <h2 class="results-title">
                    <span class="results-icon">ğŸ“‹</span>
                    Î•Ï€ÏŒÎ¼ÎµÎ½ÎµÏ‚ Î¥Ï€Î¿Ï‡ÏÎµÏÏƒÎµÎ¹Ï‚
                </h2>
                <div class="results-meta">
                    <span class="badge badge-primary">{{ upcoming_count }} Ï…Ï€Î¿Ï‡ÏÎµÏÏƒÎµÎ¹Ï‚</span>
                    <button type="button" onclick="toggleTableCompactView()" class="btn btn-icon" title="Toggle compact view">
                        <span>â—°</span>
                    </button>
                </div>
            </div>
            <div class="results-actions">
                <a href="/accounting/export-excel/?{{ request.GET.urlencode }}" class="btn btn-secondary btn-sm">
                    <span class="icon">ğŸ“Š</span>
                    <span>Export Excel</span>
                </a>
                <button type="button" onclick="toggleTableFullscreen()" class="btn btn-icon" title="Fullscreen">
                    <span>â›¶</span>
                </button>
            </div>
        </div>

        {% if upcoming %}
        <div class="table-container">
            <div class="table-wrapper">
                <table class="data-table" id="obligations-table">
                    <thead>
                        <tr>
                            <th class="col-checkbox">
                                <input type="checkbox" id="select-all-header" onchange="toggleAllCheckboxes(this)"
                                       aria-label="Select all obligations" title="Select/deselect all">
                            </th>
                            <th class="col-deadline sortable" data-sort="deadline">
                                <span>ğŸ“… Î ÏÎ¿Î¸ÎµÏƒÎ¼Î¯Î±</span>
                                <span class="sort-indicator">â¬</span>
                            </th>
                            <th class="col-client sortable" data-sort="client">
                                <span>ğŸ‘¤ Î ÎµÎ»Î¬Ï„Î·Ï‚</span>
                                <span class="sort-indicator">â¬</span>
                            </th>
                            <th class="col-obligation">ğŸ“‹ Î¥Ï€Î¿Ï‡ÏÎ­Ï‰ÏƒÎ·</th>
                            <th class="col-status center sortable" data-sort="status">
                                <span>ğŸ“Š ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</span>
                                <span class="sort-indicator">â¬</span>
                            </th>
                            <th class="col-actions center">âš™ï¸ Î•Î½Î­ÏÎ³ÎµÎ¹ÎµÏ‚</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for obl in upcoming %}
                        <tr class="data-row"
                            data-obligation-id="{{ obl.id }}"
                            data-client-id="{{ obl.client.id }}"
                            data-client-afm="{{ obl.client.afm }}"
                            data-client-name="{{ obl.client.eponimia }}"
                            data-status="{{ obl.status }}"
                            data-deadline="{{ obl.deadline|date:'Y-m-d' }}"
                            role="row">

                            <!-- Checkbox -->
                            <td class="col-checkbox">
                                <input type="checkbox" class="obl-checkbox"
                                       value="{{ obl.id }}"
                                       data-client-afm="{{ obl.client.afm }}"
                                       data-client-name="{{ obl.client.eponimia }}"
                                       data-obligation-type="{{ obl.obligation_type.name }}"
                                       data-deadline="{{ obl.deadline|date:'d/m/Y' }}"
                                       onchange="updateBulkBar()"
                                       aria-label="Select this obligation">
                            </td>

                            <!-- Deadline -->
                            <td class="col-deadline clickable" onclick="event.stopPropagation(); navigateToObligation({{ obl.id }})">
                                <div class="deadline-badge">
                                    <div class="deadline-date">{{ obl.deadline|date:"d/m/Y" }}</div>
                                    <div class="deadline-day">{{ obl.deadline|date:"D" }}</div>
                                </div>
                            </td>

                            <!-- Client -->
                            <td class="col-client">
                                <a href="{% url 'accounting:client_detail' obl.client.id %}"
                                   onclick="event.stopPropagation();"
                                   class="client-link" title="View client details">
                                    <div class="client-avatar">{{ obl.client.eponimia|first|upper }}</div>
                                    <div class="client-info">
                                        <div class="client-name">{{ obl.client.eponimia }}</div>
                                        <div class="client-afm">{{ obl.client.afm }}</div>
                                    </div>
                                </a>
                            </td>

                            <!-- Obligation Type -->
                            <td class="col-obligation clickable" onclick="event.stopPropagation(); navigateToObligation({{ obl.id }})">
                                <div class="obligation-type-badge">
                                    <span class="obligation-type-name">{{ obl.obligation_type.name }}</span>
                                    {% if obl.notes %}
                                    <span class="obligation-has-notes" title="Has notes">ğŸ“</span>
                                    {% endif %}
                                </div>
                            </td>

                            <!-- Status -->
                            <td class="col-status center clickable" onclick="event.stopPropagation(); navigateToObligation({{ obl.id }})">
                                {% if obl.status  ==  'completed' %}
                                <span class="status-badge status-completed" data-status="completed">
                                    <span class="status-icon">âœ“</span>
                                    <span class="status-label">ÎŸÎ»Î¿ÎºÎ»Î·ÏÏ‰Î¼Î­Î½Î·</span>
                                </span>
                                {% elif obl.status  ==  'overdue' %}
                                <span class="status-badge status-overdue" data-status="overdue">
                                    <span class="status-icon">âš ï¸</span>
                                    <span class="status-label">ÎšÎ±Î¸Ï…ÏƒÏ„ÎµÏÎ·Î¼Î­Î½Î·</span>
                                </span>
                                {% else %}
                                <span class="status-badge status-pending" data-status="pending">
                                    <span class="status-icon">â³</span>
                                    <span class="status-label">Î•ÎºÎºÏÎµÎ¼Î®Ï‚</span>
                                </span>
                                {% endif %}
                            </td>

                            <!-- Actions -->
                            <td class="col-actions center">
                                {% if obl.status != 'completed' %}
                                <div class="action-buttons">
                                    <button type="button"
                                            onclick="event.stopPropagation(); showCompletionModal({{ obl.id }});"
                                            class="btn btn-action btn-success btn-sm"
                                            title="ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ· Ï…Ï€Î¿Ï‡ÏÎ­Ï‰ÏƒÎ·Ï‚ (Î¼Îµ Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ Î±ÏÏ‡ÎµÎ¯Î¿ ÎºÎ±Î¹ email)">
                                        <span class="icon">âœ“</span>
                                        <span class="label">ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·</span>
                                    </button>
                                    <button type="button"
                                            onclick="event.stopPropagation(); navigateToObligation({{ obl.id }});"
                                            class="btn btn-action btn-info btn-sm"
                                            title="Î ÏÎ¿Î²Î¿Î»Î® Î»ÎµÏ€Ï„Î¿Î¼ÎµÏÎµÎ¹ÏÎ½">
                                        <span class="icon">ğŸ‘ï¸</span>
                                    </button>
                                </div>
                                {% else %}
                                <div class="completed-actions">
                                    <span class="completed-icon" title="Completed">âœ“</span>
                                    {% if obl.attachment %}
                                    <a href="{{ obl.attachment.url }}"
                                       target="_blank"
                                       onclick="event.stopPropagation();"
                                       class="attachment-link"
                                       title="Download attachment">
                                        ğŸ“
                                    </a>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        {% else %}
        <div class="empty-state">
            <div class="empty-icon">ğŸ“­</div>
            <div class="empty-content">
                <h3 class="empty-title">Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Ï…Ï€Î¿Ï‡ÏÎµÏÏƒÎµÎ¹Ï‚</h3>
                <p class="empty-description">Î”Î¿ÎºÎ¹Î¼Î¬ÏƒÏ„Îµ Î½Î± Î±Î»Î»Î¬Î¾ÎµÏ„Îµ Ï„Î± Ï†Î¯Î»Ï„ÏÎ± Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ·Ï‚</p>
                <button type="button" onclick="clearFilters()" class="btn btn-primary">
                    ğŸ”„ ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Î¦Î¯Î»Ï„ÏÏ‰Î½
                </button>
            </div>
        </div>
        {% endif %}

        <!-- TABLE FOOTER WITH PAGINATION INFO -->
        {% if upcoming %}
        <div class="table-footer">
            <div class="footer-info">
                <span>Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· <strong>{{ upcoming|length }}</strong> Î±Ï€ÏŒ <strong>{{ upcoming_count }}</strong> ÏƒÏ…Î½Î¿Î»Î¹ÎºÎ¬</span>
            </div>
        </div>
        {% endif %}
    </section>

</div>

<!-- WIZARD MODAL -->
<div id="wizard-modal" class="modal wizard-modal" style="display: none;">
    <div class="modal-content">
        <!-- Header -->
        <div class="wizard-header">
            <div>
                <h2 id="wizard-title">Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î¥Ï€Î¿Ï‡ÏÎµÏÏƒÎµÏ‰Î½</h2>
                <span class="wizard-progress-text" id="wizard-progress-text">1 Î±Ï€ÏŒ 5</span>
            </div>
            <button type="button" class="modal-close" onclick="closeWizard()" style="color: white;">&times;</button>
        </div>

        <!-- Body -->
        <div class="wizard-body" id="wizard-body">
            <!-- Obligation Info -->
            <div class="wizard-obligation-info">
                <div class="info-row">
                    <span class="info-label">Î ÎµÎ»Î¬Ï„Î·Ï‚:</span>
                    <span class="info-value client-name" id="wizard-client-name">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Î‘Î¦Îœ:</span>
                    <span class="info-value" id="wizard-client-afm">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Î¥Ï€Î¿Ï‡ÏÎ­Ï‰ÏƒÎ·:</span>
                    <span class="info-value">
                        <span class="obligation-type" id="wizard-obligation-type">-</span>
                    </span>
                </div>
                <div class="info-row">
                    <span class="info-label">Î ÎµÏÎ¯Î¿Î´Î¿Ï‚:</span>
                    <span class="info-value" id="wizard-period">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Î ÏÎ¿Î¸ÎµÏƒÎ¼Î¯Î±:</span>
                    <span class="info-value" id="wizard-deadline">-</span>
                </div>
            </div>

            <!-- File Upload -->
            <div class="wizard-file-upload">
                <label class="form-label"><span class="icon">ğŸ“</span> Î‘ÏÏ‡ÎµÎ¯Î¿ (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ)</label>
                <div class="wizard-dropzone" id="wizard-dropzone" onclick="document.getElementById('wizard-file-input').click()">
                    <div class="wizard-dropzone-icon">ğŸ“</div>
                    <div class="wizard-dropzone-text">Î£ÏÏÎµ Î±ÏÏ‡ÎµÎ¯Î¿ ÎµÎ´Ï Î® ÎºÎ¬Î½Îµ ÎºÎ»Î¹Îº Î³Î¹Î± ÎµÏ€Î¹Î»Î¿Î³Î®</div>
                    <button type="button" class="wizard-dropzone-btn">Î•Ï€Î¹Î»Î¿Î³Î® Î‘ÏÏ‡ÎµÎ¯Î¿Ï…</button>
                </div>
                <input type="file" id="wizard-file-input" style="display: none;"
                       accept=".pdf,.xlsx,.xls,.docx,.doc,.jpg,.jpeg,.png,.zip"
                       onchange="handleWizardFileSelect(this)">
                <div class="wizard-file-preview" id="wizard-file-preview" style="display: none;">
                    <span class="file-icon">ğŸ“„</span>
                    <span class="file-name" id="wizard-file-name">filename.pdf</span>
                    <button type="button" class="file-remove" onclick="removeWizardFile()">&times;</button>
                </div>
            </div>

            <!-- Options -->
            <div class="wizard-options">
                <div class="wizard-checkbox-group">
                    <label class="wizard-checkbox-label" id="complete-label">
                        <input type="checkbox" class="wizard-checkbox" id="wizard-complete-checkbox"
                               onchange="updateWizardCheckboxState()" checked>
                        <span class="icon">âœ…</span>
                        <span>ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ· Ï…Ï€Î¿Ï‡ÏÎ­Ï‰ÏƒÎ·Ï‚</span>
                    </label>
                    <label class="wizard-checkbox-label" id="skip-label">
                        <input type="checkbox" class="wizard-checkbox" id="wizard-skip-checkbox"
                               onchange="updateWizardCheckboxState()">
                        <span class="icon">â­ï¸</span>
                        <span>Î Î±ÏÎ¬Î»ÎµÎ¹ÏˆÎ· (Ï‡Ï‰ÏÎ¯Ï‚ Î±Î»Î»Î±Î³Î­Ï‚)</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="wizard-footer">
            <div class="wizard-nav-btns">
                <button type="button" class="btn-wizard-prev" id="wizard-prev-btn" onclick="wizardPrev()">
                    â† Î ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î·
                </button>
            </div>
            <div class="wizard-progress-dots" id="wizard-dots">
                <!-- Dots will be generated dynamically -->
            </div>
            <div class="wizard-nav-btns">
                <button type="button" class="btn-wizard-next" id="wizard-next-btn" onclick="wizardNext()">
                    Î•Ï€ÏŒÎ¼ÎµÎ½Î· â†’
                </button>
                <button type="button" class="btn-wizard-finish" id="wizard-finish-btn" onclick="wizardFinish()" style="display: none;">
                    âœ“ ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ· ÎŒÎ»Ï‰Î½
                </button>
            </div>
        </div>
    </div>
</div>

<!-- SCRIPTS -->
<script src="{% static 'accounting/js/dashboard.js' %}"></script>
<script>
    // ============================================================================
    // HELPER FUNCTIONS (defined here to ensure availability in inline script)
    // ============================================================================

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 10000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        `;

        if (type === 'success') {
            notification.style.backgroundColor = '#d1fae5';
            notification.style.color = '#065f46';
            notification.style.borderLeft = '4px solid #10b981';
        } else if (type === 'error') {
            notification.style.backgroundColor = '#fee2e2';
            notification.style.color = '#991b1b';
            notification.style.borderLeft = '4px solid #ef4444';
        } else {
            notification.style.backgroundColor = '#dbeafe';
            notification.style.color = '#1e40af';
            notification.style.borderLeft = '4px solid #3b82f6';
        }

        notification.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px;">
                <span>${message}</span>
                <button onclick="this.parentElement.parentElement.remove()"
                        style="background: none; border: none; font-size: 20px; cursor: pointer; opacity: 0.7;">&times;</button>
            </div>
        `;

        document.body.appendChild(notification);

        // Auto remove after 5 seconds
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(100%)';
            notification.style.transition = 'all 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 5000);
    }

    // ============================================================================
    // INITIALIZATION
    // ============================================================================

    // Initialize dashboard on load
    document.addEventListener('DOMContentLoaded', function () {
        console.log('âœ… Dashboard loaded');
        initializeFilterPresets();
    });

    // Filter preset buttons
    function initializeFilterPresets() {
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
        const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

        document.getElementById('filter-preset-today')?.addEventListener('click', () => {
            document.getElementById('filter-date-from').value = todayStr;
            document.getElementById('filter-date-to').value = todayStr;
            document.getElementById('filter-form').submit();
        });

        document.getElementById('filter-preset-week')?.addEventListener('click', () => {
            document.getElementById('filter-date-from').value = weekAgo;
            document.getElementById('filter-date-to').value = todayStr;
            document.getElementById('filter-form').submit();
        });

        document.getElementById('filter-preset-month')?.addEventListener('click', () => {
            document.getElementById('filter-date-from').value = monthAgo;
            document.getElementById('filter-date-to').value = todayStr;
            document.getElementById('filter-form').submit();
        });
    }

    // Bulk selection functions
    function toggleAllCheckboxes(checkbox) {
        const checkboxes = document.querySelectorAll('.obl-checkbox');
        checkboxes.forEach(cb => cb.checked = checkbox.checked);
        updateBulkBar();
    }

    function updateBulkBar() {
        const checkboxes = document.querySelectorAll('.obl-checkbox:checked');
        const count = checkboxes.length;
        const bulkBar = document.getElementById('bulk-actions-bar');
        const countSpan = document.getElementById('selected-count');

        if (count > 0) {
            bulkBar.style.display = 'flex';
            if (countSpan) countSpan.textContent = count;
        } else {
            bulkBar.style.display = 'none';
        }
    }

    function bulkComplete() {
        const checkboxes = document.querySelectorAll('.obl-checkbox:checked');
        const obligationIds = Array.from(checkboxes).map(cb => cb.value);

        if (obligationIds.length === 0) {
            alert('Î”ÎµÎ½ Î­Ï‡ÎµÏ„Îµ ÎµÏ€Î¹Î»Î­Î¾ÎµÎ¹ ÎºÎ±Î¼Î¯Î± Ï…Ï€Î¿Ï‡ÏÎ­Ï‰ÏƒÎ·');
            return;
        }

        // Open wizard instead of simple modal
        openWizard(obligationIds);
    }

    // Bulk bar close
    function closeBulkBar() {
        document.getElementById('bulk-actions-bar').style.display = 'none';
        // Deselect all checkboxes
        document.querySelectorAll('.obl-checkbox').forEach(cb => cb.checked = false);
        document.getElementById('select-all-header').checked = false;
    }

    // Table compact view toggle
    function toggleTableCompactView() {
        document.getElementById('obligations-table')?.classList.toggle('compact');
    }

    // Fullscreen toggle
    function toggleTableFullscreen() {
        document.querySelector('.table-container')?.classList.toggle('fullscreen');
    }

    // ============================================================================
    // WIZARD FUNCTIONALITY
    // ============================================================================

    // Wizard state
    let wizardState = {
        obligations: [],     // Array of obligation objects from API
        currentIndex: 0,     // Current position in wizard
        results: {},         // { obligationId: { file: File|null, complete: bool, skip: bool } }
        files: {}            // Store files separately { obligationId: File }
    };

    // Open wizard with selected obligation IDs
    function openWizard(obligationIds) {
        console.log('Opening wizard with IDs:', obligationIds);

        // Show loading state
        const modal = document.getElementById('wizard-modal');
        modal.style.display = 'flex';
        document.getElementById('wizard-body').innerHTML = `
            <div style="text-align: center; padding: 50px;">
                <div style="font-size: 3rem; margin-bottom: 20px;">â³</div>
                <p>Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Ï…Ï€Î¿Ï‡ÏÎµÏÏƒÎµÏ‰Î½...</p>
            </div>
        `;

        // Fetch obligation details from API
        fetch(`/accounting/api/obligations-wizard/?ids=${obligationIds.join(',')}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.obligations.length > 0) {
                    // Initialize wizard state
                    wizardState.obligations = data.obligations;
                    wizardState.currentIndex = 0;
                    wizardState.results = {};
                    wizardState.files = {};

                    // Initialize results for each obligation
                    data.obligations.forEach(ob => {
                        wizardState.results[ob.id] = {
                            complete: true,
                            skip: false,
                            notes: ''
                        };
                    });

                    // Restore wizard body
                    restoreWizardBody();

                    // Generate progress dots
                    generateProgressDots();

                    // Render first obligation
                    renderCurrentObligation();
                } else {
                    showNotification('âŒ Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Ï…Ï€Î¿Ï‡ÏÎµÏÏƒÎµÎ¹Ï‚', 'error');
                    closeWizard();
                }
            })
            .catch(error => {
                console.error('Error fetching obligations:', error);
                showNotification('âŒ Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ Ï…Ï€Î¿Ï‡ÏÎµÏÏƒÎµÏ‰Î½', 'error');
                closeWizard();
            });
    }

    // Restore wizard body HTML
    function restoreWizardBody() {
        document.getElementById('wizard-body').innerHTML = `
            <!-- Obligation Info -->
            <div class="wizard-obligation-info">
                <div class="info-row">
                    <span class="info-label">Î ÎµÎ»Î¬Ï„Î·Ï‚:</span>
                    <span class="info-value client-name" id="wizard-client-name">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Î‘Î¦Îœ:</span>
                    <span class="info-value" id="wizard-client-afm">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Î¥Ï€Î¿Ï‡ÏÎ­Ï‰ÏƒÎ·:</span>
                    <span class="info-value">
                        <span class="obligation-type" id="wizard-obligation-type">-</span>
                    </span>
                </div>
                <div class="info-row">
                    <span class="info-label">Î ÎµÏÎ¯Î¿Î´Î¿Ï‚:</span>
                    <span class="info-value" id="wizard-period">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Î ÏÎ¿Î¸ÎµÏƒÎ¼Î¯Î±:</span>
                    <span class="info-value" id="wizard-deadline">-</span>
                </div>
            </div>

            <!-- File Upload -->
            <div class="wizard-file-upload">
                <label class="form-label"><span class="icon">ğŸ“</span> Î‘ÏÏ‡ÎµÎ¯Î¿ (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ)</label>
                <div class="wizard-dropzone" id="wizard-dropzone" onclick="document.getElementById('wizard-file-input').click()">
                    <div class="wizard-dropzone-icon">ğŸ“</div>
                    <div class="wizard-dropzone-text">Î£ÏÏÎµ Î±ÏÏ‡ÎµÎ¯Î¿ ÎµÎ´Ï Î® ÎºÎ¬Î½Îµ ÎºÎ»Î¹Îº Î³Î¹Î± ÎµÏ€Î¹Î»Î¿Î³Î®</div>
                    <button type="button" class="wizard-dropzone-btn">Î•Ï€Î¹Î»Î¿Î³Î® Î‘ÏÏ‡ÎµÎ¯Î¿Ï…</button>
                </div>
                <input type="file" id="wizard-file-input" style="display: none;"
                       accept=".pdf,.xlsx,.xls,.docx,.doc,.jpg,.jpeg,.png,.zip"
                       onchange="handleWizardFileSelect(this)">
                <div class="wizard-file-preview" id="wizard-file-preview" style="display: none;">
                    <span class="file-icon">ğŸ“„</span>
                    <span class="file-name" id="wizard-file-name">filename.pdf</span>
                    <button type="button" class="file-remove" onclick="removeWizardFile()">&times;</button>
                </div>
            </div>

            <!-- Options -->
            <div class="wizard-options">
                <div class="wizard-checkbox-group">
                    <label class="wizard-checkbox-label" id="complete-label">
                        <input type="checkbox" class="wizard-checkbox" id="wizard-complete-checkbox"
                               onchange="updateWizardCheckboxState()" checked>
                        <span class="icon">âœ…</span>
                        <span>ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ· Ï…Ï€Î¿Ï‡ÏÎ­Ï‰ÏƒÎ·Ï‚</span>
                    </label>
                    <label class="wizard-checkbox-label" id="skip-label">
                        <input type="checkbox" class="wizard-checkbox" id="wizard-skip-checkbox"
                               onchange="updateWizardCheckboxState()">
                        <span class="icon">â­ï¸</span>
                        <span>Î Î±ÏÎ¬Î»ÎµÎ¹ÏˆÎ· (Ï‡Ï‰ÏÎ¯Ï‚ Î±Î»Î»Î±Î³Î­Ï‚)</span>
                    </label>
                </div>
            </div>
        `;

        // Add drag and drop handlers
        const dropzone = document.getElementById('wizard-dropzone');
        if (dropzone) {
            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.classList.add('dragging');
            });
            dropzone.addEventListener('dragleave', () => {
                dropzone.classList.remove('dragging');
            });
            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.classList.remove('dragging');
                if (e.dataTransfer.files.length > 0) {
                    document.getElementById('wizard-file-input').files = e.dataTransfer.files;
                    handleWizardFileSelect(document.getElementById('wizard-file-input'));
                }
            });
        }
    }

    // Generate progress dots
    function generateProgressDots() {
        const dotsContainer = document.getElementById('wizard-dots');
        dotsContainer.innerHTML = '';

        // Limit dots to show (max 10, then show count)
        const totalObs = wizardState.obligations.length;
        const maxDots = Math.min(totalObs, 10);

        for (let i = 0; i < maxDots; i++) {
            const dot = document.createElement('div');
            dot.className = 'wizard-dot';
            dot.title = `Î¥Ï€Î¿Ï‡ÏÎ­Ï‰ÏƒÎ· ${i + 1}`;
            dotsContainer.appendChild(dot);
        }

        if (totalObs > 10) {
            const more = document.createElement('span');
            more.textContent = `+${totalObs - 10}`;
            more.style.marginLeft = '5px';
            more.style.fontSize = '0.8rem';
            more.style.color = '#6c757d';
            dotsContainer.appendChild(more);
        }
    }

    // Update progress dots
    function updateProgressDots() {
        const dots = document.querySelectorAll('.wizard-dot');
        dots.forEach((dot, i) => {
            dot.classList.remove('active', 'completed', 'skipped');

            if (i === wizardState.currentIndex) {
                dot.classList.add('active');
            } else if (i < wizardState.currentIndex) {
                const ob = wizardState.obligations[i];
                const result = wizardState.results[ob.id];
                if (result && result.skip) {
                    dot.classList.add('skipped');
                } else {
                    dot.classList.add('completed');
                }
            }
        });
    }

    // Render current obligation in wizard
    function renderCurrentObligation() {
        const ob = wizardState.obligations[wizardState.currentIndex];
        const result = wizardState.results[ob.id] || { complete: true, skip: false };

        // Update info fields
        document.getElementById('wizard-client-name').textContent = ob.client_name;
        document.getElementById('wizard-client-afm').textContent = ob.client_afm;
        document.getElementById('wizard-obligation-type').textContent = ob.obligation_type;
        document.getElementById('wizard-period').textContent = ob.period_display;
        document.getElementById('wizard-deadline').textContent = ob.due_date;

        // Update progress text
        document.getElementById('wizard-progress-text').textContent =
            `${wizardState.currentIndex + 1} Î±Ï€ÏŒ ${wizardState.obligations.length}`;

        // Update checkboxes
        document.getElementById('wizard-complete-checkbox').checked = result.complete;
        document.getElementById('wizard-skip-checkbox').checked = result.skip;
        updateWizardCheckboxState();

        // Show/hide file if previously selected
        const filePreview = document.getElementById('wizard-file-preview');
        const dropzone = document.getElementById('wizard-dropzone');
        if (wizardState.files[ob.id]) {
            document.getElementById('wizard-file-name').textContent = wizardState.files[ob.id].name;
            filePreview.style.display = 'flex';
            dropzone.style.display = 'none';
        } else {
            filePreview.style.display = 'none';
            dropzone.style.display = 'block';
        }

        // Clear file input
        document.getElementById('wizard-file-input').value = '';

        // Update navigation buttons
        updateNavigationButtons();

        // Update dots
        updateProgressDots();
    }

    // Update navigation buttons state
    function updateNavigationButtons() {
        const prevBtn = document.getElementById('wizard-prev-btn');
        const nextBtn = document.getElementById('wizard-next-btn');
        const finishBtn = document.getElementById('wizard-finish-btn');

        prevBtn.disabled = wizardState.currentIndex === 0;

        const isLast = wizardState.currentIndex === wizardState.obligations.length - 1;
        nextBtn.style.display = isLast ? 'none' : 'flex';
        finishBtn.style.display = isLast ? 'block' : 'none';
    }

    // Save current state before navigation
    function saveCurrentState() {
        const ob = wizardState.obligations[wizardState.currentIndex];

        wizardState.results[ob.id] = {
            complete: document.getElementById('wizard-complete-checkbox').checked,
            skip: document.getElementById('wizard-skip-checkbox').checked,
            notes: ''
        };

        // File is already saved in wizardState.files when selected
    }

    // Navigate to previous obligation
    function wizardPrev() {
        if (wizardState.currentIndex > 0) {
            saveCurrentState();
            wizardState.currentIndex--;
            renderCurrentObligation();
        }
    }

    // Navigate to next obligation
    function wizardNext() {
        if (wizardState.currentIndex < wizardState.obligations.length - 1) {
            saveCurrentState();
            wizardState.currentIndex++;
            renderCurrentObligation();
        }
    }

    // Handle file selection
    function handleWizardFileSelect(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const ob = wizardState.obligations[wizardState.currentIndex];

            // Store file
            wizardState.files[ob.id] = file;

            // Update UI
            document.getElementById('wizard-file-name').textContent = file.name;
            document.getElementById('wizard-file-preview').style.display = 'flex';
            document.getElementById('wizard-dropzone').style.display = 'none';
        }
    }

    // Remove selected file
    function removeWizardFile() {
        const ob = wizardState.obligations[wizardState.currentIndex];
        delete wizardState.files[ob.id];

        document.getElementById('wizard-file-input').value = '';
        document.getElementById('wizard-file-preview').style.display = 'none';
        document.getElementById('wizard-dropzone').style.display = 'block';
    }

    // Update checkbox visual state
    function updateWizardCheckboxState() {
        const completeCheck = document.getElementById('wizard-complete-checkbox');
        const skipCheck = document.getElementById('wizard-skip-checkbox');
        const completeLabel = document.getElementById('complete-label');
        const skipLabel = document.getElementById('skip-label');

        // Mutual exclusion
        if (skipCheck.checked) {
            completeCheck.checked = false;
        }

        // Update visual state
        completeLabel.classList.toggle('checked', completeCheck.checked);
        skipLabel.classList.toggle('skip-checked', skipCheck.checked);
    }

    // Finish wizard and submit all
    function wizardFinish() {
        saveCurrentState();

        // Count completions and skips
        let completeCount = 0;
        let skipCount = 0;

        Object.values(wizardState.results).forEach(r => {
            if (r.skip) {
                skipCount++;
            } else if (r.complete) {
                completeCount++;
            }
        });

        if (completeCount === 0 && skipCount === wizardState.obligations.length) {
            if (!confirm('ÎŒÎ»ÎµÏ‚ Î¿Î¹ Ï…Ï€Î¿Ï‡ÏÎµÏÏƒÎµÎ¹Ï‚ Î¸Î± Ï€Î±ÏÎ±Î»ÎµÎ¹Ï†Î¸Î¿ÏÎ½. Î•Î¯ÏƒÏ„Îµ ÏƒÎ¯Î³Î¿Ï…ÏÎ¿Î¹;')) {
                return;
            }
        }

        // Build FormData for submission
        const formData = new FormData();
        formData.append('results', JSON.stringify(wizardState.results));

        // Add files
        for (const [obId, file] of Object.entries(wizardState.files)) {
            formData.append(`file_${obId}`, file);
        }

        // Show loading
        const finishBtn = document.getElementById('wizard-finish-btn');
        const originalText = finishBtn.innerHTML;
        finishBtn.disabled = true;
        finishBtn.innerHTML = 'â³ Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±...';

        // Submit to server
        fetch('/accounting/wizard-bulk-process/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                closeWizard();
                setTimeout(() => window.location.reload(), 1500);
            } else {
                throw new Error(data.error || 'Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ ÎµÏ€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('âŒ ' + error.message, 'error');
            finishBtn.disabled = false;
            finishBtn.innerHTML = originalText;
        });
    }

    // Close wizard
    function closeWizard() {
        document.getElementById('wizard-modal').style.display = 'none';

        // Reset state
        wizardState = {
            obligations: [],
            currentIndex: 0,
            results: {},
            files: {}
        };
    }

    // Select all helper
    function selectAll() {
        document.querySelectorAll('.obl-checkbox').forEach(cb => cb.checked = true);
        document.getElementById('select-all-header').checked = true;
        updateBulkBar();
    }

    // Deselect all helper
    function deselectAll() {
        document.querySelectorAll('.obl-checkbox').forEach(cb => cb.checked = false);
        document.getElementById('select-all-header').checked = false;
        updateBulkBar();
    }

    // Placeholder functions for other bulk actions
    function bulkEmail() {
        const checkboxes = document.querySelectorAll('.obl-checkbox:checked');
        if (checkboxes.length === 0) {
            alert('Î”ÎµÎ½ Î­Ï‡ÎµÏ„Îµ ÎµÏ€Î¹Î»Î­Î¾ÎµÎ¹ ÎºÎ±Î¼Î¯Î± Ï…Ï€Î¿Ï‡ÏÎ­Ï‰ÏƒÎ·');
            return;
        }
        alert('Î— Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± Î¼Î±Î¶Î¹ÎºÎ¿Ï email Î¸Î± Ï…Î»Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ ÏƒÏÎ½Ï„Î¿Î¼Î±');
    }

    function bulkExport() {
        const checkboxes = document.querySelectorAll('.obl-checkbox:checked');
        if (checkboxes.length === 0) {
            alert('Î”ÎµÎ½ Î­Ï‡ÎµÏ„Îµ ÎµÏ€Î¹Î»Î­Î¾ÎµÎ¹ ÎºÎ±Î¼Î¯Î± Ï…Ï€Î¿Ï‡ÏÎ­Ï‰ÏƒÎ·');
            return;
        }
        // Redirect to export with selected IDs
        const ids = Array.from(checkboxes).map(cb => cb.value).join(',');
        window.location.href = `/accounting/export-excel/?ids=${ids}`;
    }

    function bulkDelete() {
        const checkboxes = document.querySelectorAll('.obl-checkbox:checked');
        if (checkboxes.length === 0) {
            alert('Î”ÎµÎ½ Î­Ï‡ÎµÏ„Îµ ÎµÏ€Î¹Î»Î­Î¾ÎµÎ¹ ÎºÎ±Î¼Î¯Î± Ï…Ï€Î¿Ï‡ÏÎ­Ï‰ÏƒÎ·');
            return;
        }
        alert('Î— Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± Î¼Î±Î¶Î¹ÎºÎ®Ï‚ Î´Î¹Î±Î³ÏÎ±Ï†Î®Ï‚ Î±Ï€Î±Î¹Ï„ÎµÎ¯ ÎµÏ€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·. Î•Ï€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î®ÏƒÏ„Îµ Î¼Îµ Ï„Î¿Î½ Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î®.');
    }
</script>

{% endblock %}