{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
<link rel="stylesheet" href="{% static 'accounting/css/dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-wrapper">

    <!-- ğŸšª DOOR WIDGET - TOP RIGHT -->
    <div class="door-widget-container">
        {% include 'accounting/door_widget.html' %}
    </div>

    <!-- PAGE HEADER WITH NAVIGATION -->
    <header class="dashboard-header">
        <div class="header-wrapper">
            <div class="header-left">
                <div class="header-icon">ğŸ“Š</div>
                <div class="header-content">
                    <h1 class="page-title">Dashboard - Î•Ï€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ·</h1>
                    <p class="page-subtitle">Î ÏÎ¿Î·Î³Î¼Î­Î½Î· Î´Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Ï…Ï€Î¿Ï‡ÏÎµÏÏƒÎµÏ‰Î½ Î¼Îµ Î­Î¾Ï…Ï€Î½Î· Î±Î½Î¬Î»Ï…ÏƒÎ·</p>
                </div>
            </div>
            <div class="header-right">
                <a href="{% url 'accounting:reports' %}" class="btn btn-gradient btn-lg">
                    <span class="icon">ğŸ“ˆ</span>
                    <span>Reports & Analytics</span>
                </a>
            </div>
        </div>

        <!-- STATS CARDS -->
        <div class="stats-grid">
            <div class="stat-card stat-pending">
                <div class="stat-icon">â³</div>
                <div class="stat-content">
                    <div class="stat-label">Î•ÎºÎºÏÎµÎ¼ÎµÎ¯Ï‚</div>
                    <div class="stat-value">{{ pending }}</div>
                </div>
            </div>
            <div class="stat-card stat-completed">
                <div class="stat-icon">âœ…</div>
                <div class="stat-content">
                    <div class="stat-label">ÎŸÎ»Î¿ÎºÎ»Î·ÏÏ‰Î¼Î­Î½ÎµÏ‚</div>
                    <div class="stat-value">{{ completed }}</div>
                </div>
            </div>
            <div class="stat-card stat-overdue">
                <div class="stat-icon">âš ï¸</div>
                <div class="stat-content">
                    <div class="stat-label">ÎšÎ±Î¸Ï…ÏƒÏ„ÎµÏÎ·Î¼Î­Î½ÎµÏ‚</div>
                    <div class="stat-value">{{ overdue }}</div>
                </div>
            </div>
            <div class="stat-card stat-total">
                <div class="stat-icon">ğŸ‘¥</div>
                <div class="stat-content">
                    <div class="stat-label">Î£ÏÎ½Î¿Î»Î¿ Î ÎµÎ»Î±Ï„ÏÎ½</div>
                    <div class="stat-value">{{ total_clients }}</div>
                </div>
            </div>
        </div>
    </header>

    <!-- FILTERS SECTION WITH ANIMATIONS -->
    <section class="filters-section">
        <div class="filters-badge" id="active-filters-count" style="display: none;">0</div>

        <div class="filters-header">
            <div class="filters-title-group">
                <h2 class="filters-title">
                    <span class="filters-icon">ğŸ”</span>
                    Î¦Î¯Î»Ï„ÏÎ± & Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·
                </h2>
                <div class="filters-subtitle">Î‘Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î±: <strong>{{ upcoming_count }}</strong></div>
            </div>
            <button type="button" id="filters-toggle" class="btn btn-icon" title="Expand/Collapse filters">
                <span>â–¼</span>
            </button>
        </div>

        <form method="get" id="filter-form" class="filters-form">
            <div class="filters-content">

                <!-- MAIN FILTERS GRID -->
                <div class="filters-grid">
                    <!-- Status -->
                    <div class="filter-group">
                        <label for="filter-status" class="filter-label">
                            <span class="filter-icon">ğŸ“Š</span>
                            ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·
                        </label>
                        <select id="filter-status" name="status" class="filter-select" data-filter="status">
                            <option value="">-- ÎŒÎ»ÎµÏ‚ --</option>
                            <option value="pending" {% if filter_status == 'pending' %}selected{% endif %}>â³ Î•ÎºÎºÏÎµÎ¼ÎµÎ¯Ï‚</option>
                            <option value="completed" {% if filter_status == 'completed' %}selected{% endif %}>âœ… ÎŸÎ»Î¿ÎºÎ»Î·ÏÏ‰Î¼Î­Î½ÎµÏ‚</option>
                            <option value="overdue" {% if filter_status == 'overdue' %}selected{% endif %}>âš ï¸ ÎšÎ±Î¸Ï…ÏƒÏ„ÎµÏÎ·Î¼Î­Î½ÎµÏ‚</option>
                        </select>
                    </div>

                    <!-- Client -->
                    <div class="filter-group">
                        <label for="filter-client" class="filter-label">
                            <span class="filter-icon">ğŸ‘¤</span>
                            Î ÎµÎ»Î¬Ï„Î·Ï‚
                        </label>
                        <select id="filter-client" name="client" class="filter-select" data-filter="client">
                            <option value="">-- ÎŒÎ»Î¿Î¹ Î¿Î¹ Ï€ÎµÎ»Î¬Ï„ÎµÏ‚ --</option>
                            {% for client in all_clients %}
                            <option value="{{ client.id }}" {% if filter_client == client.id|stringformat:"s" %}selected{% endif %}>
                                {{ client.eponimia }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Type -->
                    <div class="filter-group">
                        <label for="filter-type" class="filter-label">
                            <span class="filter-icon">ğŸ“‹</span>
                            Î¤ÏÏ€Î¿Ï‚ Î¥Ï€Î¿Ï‡ÏÎ­Ï‰ÏƒÎ·Ï‚
                        </label>
                        <select id="filter-type" name="type" class="filter-select" data-filter="type">
                            <option value="">-- ÎŒÎ»Î¿Î¹ Î¿Î¹ Ï„ÏÏ€Î¿Î¹ --</option>
                            {% for type in all_types %}
                            <option value="{{ type.id }}" {% if filter_type == type.id|stringformat:"s" %}selected{% endif %}>
                                {{ type.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Date Range -->
                    <div class="filter-group">
                        <label for="filter-date-from" class="filter-label">
                            <span class="filter-icon">ğŸ“…</span>
                            Î ÎµÏÎ¯Î¿Î´Î¿Ï‚
                        </label>
                        <div class="date-range-inputs">
                            <input type="date" id="filter-date-from" name="date_from"
                                   class="date-input" placeholder="Î‘Ï€ÏŒ" value="{{ date_from }}">
                            <span class="date-separator">â†’</span>
                            <input type="date" id="filter-date-to" name="date_to"
                                   class="date-input" placeholder="ÎˆÏ‰Ï‚" value="{{ date_to }}">
                        </div>
                    </div>

                    <!-- Sort -->
                    <div class="filter-group">
                        <label for="filter-sort" class="filter-label">
                            <span class="filter-icon">ğŸ”„</span>
                            Î¤Î±Î¾Î¹Î½ÏŒÎ¼Î·ÏƒÎ·
                        </label>
                        <select id="filter-sort" name="sort" class="filter-select">
                            <option value="deadline" {% if sort_by == 'deadline' %}selected{% endif %}>Î ÏÎ¿Î¸ÎµÏƒÎ¼Î¯Î± (Ï€ÏÏÏ„Î± ÎºÎ¿Î½Ï„Î¹Î½Î­Ï‚)</option>
                            <option value="client" {% if sort_by == 'client' %}selected{% endif %}>Î ÎµÎ»Î¬Ï„Î·Ï‚ (A-Z)</option>
                            <option value="type" {% if sort_by == 'type' %}selected{% endif %}>Î¤ÏÏ€Î¿Ï‚</option>
                            <option value="status" {% if sort_by == 'status' %}selected{% endif %}>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</option>
                        </select>
                    </div>
                </div>

                <!-- ACTIVE FILTERS DISPLAY -->
                <div id="active-filters-display" class="active-filters-display" style="display: none;">
                    <span class="active-label">Î•Î½ÎµÏÎ³Î¬ Ï†Î¯Î»Ï„ÏÎ±:</span>
                    <div id="active-filters-list" class="active-filters-list"></div>
                </div>

                <!-- FILTER ACTIONS -->
                <div class="filter-actions">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <span class="icon">ğŸ”</span>
                        <span>Î•Ï†Î±ÏÎ¼Î¿Î³Î® Î¦Î¯Î»Ï„ÏÏ‰Î½</span>
                    </button>
                    <button type="button" onclick="clearFilters()" class="btn btn-secondary">
                        <span class="icon">âœ–ï¸</span>
                        <span>ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚</span>
                    </button>
                    <button type="button" id="filter-preset-today" class="btn btn-outline">Î£Î®Î¼ÎµÏÎ±</button>
                    <button type="button" id="filter-preset-week" class="btn btn-outline">Î‘Ï…Ï„Î® Ï„Î·Î½ ÎµÎ²Î´Î¿Î¼Î¬Î´Î±</button>
                    <button type="button" id="filter-preset-month" class="btn btn-outline">Î‘Ï…Ï„ÏŒ Ï„Î¿ Î¼Î®Î½Î±</button>
                </div>
            </div>
        </form>
    </section>

    <!-- BULK ACTIONS BAR WITH ANIMATIONS -->
    <div id="bulk-actions-bar" class="bulk-actions-bar" style="display: none;">
        <div class="bulk-info">
            <span class="bulk-count">
                <span class="icon">âœ“</span>
                <span id="selected-count">0</span>
                <span class="plural">Ï…Ï€Î¿Ï‡ÏÎµÏÏƒÎµÎ¹Ï‚</span>
            </span>
        </div>

        <div class="bulk-actions-main">
            <div class="bulk-section">
                <h4 class="bulk-section-title">Î•Ï€Î¹Î»Î¿Î³Î®</h4>
                <div class="bulk-buttons">
                    <button type="button" onclick="selectAll()" class="btn btn-small btn-outline">âœ“ ÎŒÎ»ÎµÏ‚</button>
                    <button type="button" onclick="deselectAll()" class="btn btn-small btn-outline">âœ— ÎšÎ±Î¼Î¯Î±</button>
                </div>
            </div>

            <div class="bulk-section">
                <h4 class="bulk-section-title">Î•Î½Î­ÏÎ³ÎµÎ¹ÎµÏ‚</h4>
                <div class="bulk-buttons">
                    <button type="button" onclick="showAdvancedBulkComplete()" class="btn btn-small btn-success" title="Smart completion with grouping">
                        <span class="icon">âœ“</span>
                        <span>ÎˆÎ¾Ï…Ï€Î½Î· ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·</span>
                    </button>
                    <button type="button" onclick="bulkEmail()" class="btn btn-small btn-info">
                        <span class="icon">ğŸ“§</span>
                        <span>Email</span>
                    </button>
                    <button type="button" onclick="bulkExport()" class="btn btn-small btn-primary">
                        <span class="icon">ğŸ“¥</span>
                        <span>Export</span>
                    </button>
                    <button type="button" onclick="bulkDelete()" class="btn btn-small btn-danger" title="Requires confirmation">
                        <span class="icon">ğŸ—‘ï¸</span>
                        <span>Î”Î¹Î±Î³ÏÎ±Ï†Î®</span>
                    </button>
                </div>
            </div>
        </div>

        <button type="button" onclick="closeBulkBar()" class="btn btn-icon btn-ghost" title="Close bulk actions">
            <span class="icon">Ã—</span>
        </button>
    </div>

    <!-- RESULTS TABLE WITH ADVANCED FEATURES -->
    <section class="results-section">
        <div class="results-header">
            <div class="results-title-group">
                <h2 class="results-title">
                    <span class="results-icon">ğŸ“‹</span>
                    Î•Ï€ÏŒÎ¼ÎµÎ½ÎµÏ‚ Î¥Ï€Î¿Ï‡ÏÎµÏÏƒÎµÎ¹Ï‚
                </h2>
                <div class="results-meta">
                    <span class="badge badge-primary">{{ upcoming_count }} Ï…Ï€Î¿Ï‡ÏÎµÏÏƒÎµÎ¹Ï‚</span>
                    <button type="button" onclick="toggleTableCompactView()" class="btn btn-icon" title="Toggle compact view">
                        <span>â—°</span>
                    </button>
                </div>
            </div>
            <div class="results-actions">
                <a href="/accounting/export-excel/?{{ request.GET.urlencode }}" class="btn btn-secondary btn-sm">
                    <span class="icon">ğŸ“Š</span>
                    <span>Export Excel</span>
                </a>
                <button type="button" onclick="toggleTableFullscreen()" class="btn btn-icon" title="Fullscreen">
                    <span>â›¶</span>
                </button>
            </div>
        </div>

        {% if upcoming %}
        <div class="table-container">
            <div class="table-wrapper">
                <table class="data-table" id="obligations-table">
                    <thead>
                        <tr>
                            <th class="col-checkbox">
                                <input type="checkbox" id="select-all-header" onchange="toggleAllCheckboxes(this)"
                                       aria-label="Select all obligations" title="Select/deselect all">
                            </th>
                            <th class="col-deadline sortable" data-sort="deadline">
                                <span>ğŸ“… Î ÏÎ¿Î¸ÎµÏƒÎ¼Î¯Î±</span>
                                <span class="sort-indicator">â¬</span>
                            </th>
                            <th class="col-client sortable" data-sort="client">
                                <span>ğŸ‘¤ Î ÎµÎ»Î¬Ï„Î·Ï‚</span>
                                <span class="sort-indicator">â¬</span>
                            </th>
                            <th class="col-obligation">ğŸ“‹ Î¥Ï€Î¿Ï‡ÏÎ­Ï‰ÏƒÎ·</th>
                            <th class="col-status center sortable" data-sort="status">
                                <span>ğŸ“Š ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</span>
                                <span class="sort-indicator">â¬</span>
                            </th>
                            <th class="col-actions center">âš™ï¸ Î•Î½Î­ÏÎ³ÎµÎ¹ÎµÏ‚</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for obl in upcoming %}
                        <tr class="data-row"
                            data-obligation-id="{{ obl.id }}"
                            data-client-id="{{ obl.client.id }}"
                            data-client-afm="{{ obl.client.afm }}"
                            data-client-name="{{ obl.client.eponimia }}"
                            data-status="{{ obl.status }}"
                            data-deadline="{{ obl.deadline|date:'Y-m-d' }}"
                            role="row">

                            <!-- Checkbox -->
                            <td class="col-checkbox">
                                <input type="checkbox" class="obl-checkbox"
                                       value="{{ obl.id }}"
                                       data-client-afm="{{ obl.client.afm }}"
                                       data-client-name="{{ obl.client.eponimia }}"
                                       data-obligation-type="{{ obl.obligation_type.name }}"
                                       data-deadline="{{ obl.deadline|date:'d/m/Y' }}"
                                       onchange="updateBulkBar()"
                                       aria-label="Select this obligation">
                            </td>

                            <!-- Deadline -->
                            <td class="col-deadline clickable" onclick="event.stopPropagation(); navigateToObligation({{ obl.id }})">
                                <div class="deadline-badge">
                                    <div class="deadline-date">{{ obl.deadline|date:"d/m/Y" }}</div>
                                    <div class="deadline-day">{{ obl.deadline|date:"D" }}</div>
                                </div>
                            </td>

                            <!-- Client -->
                            <td class="col-client">
                                <a href="{% url 'accounting:client_detail' obl.client.id %}"
                                   onclick="event.stopPropagation();"
                                   class="client-link" title="View client details">
                                    <div class="client-avatar">{{ obl.client.eponimia|first|upper }}</div>
                                    <div class="client-info">
                                        <div class="client-name">{{ obl.client.eponimia }}</div>
                                        <div class="client-afm">{{ obl.client.afm }}</div>
                                    </div>
                                </a>
                            </td>

                            <!-- Obligation Type -->
                            <td class="col-obligation clickable" onclick="event.stopPropagation(); navigateToObligation({{ obl.id }})">
                                <div class="obligation-type-badge">
                                    <span class="obligation-type-name">{{ obl.obligation_type.name }}</span>
                                    {% if obl.notes %}
                                    <span class="obligation-has-notes" title="Has notes">ğŸ“</span>
                                    {% endif %}
                                </div>
                            </td>

                            <!-- Status -->
                            <td class="col-status center clickable" onclick="event.stopPropagation(); navigateToObligation({{ obl.id }})">
                                {% if obl.status  ==  'completed' %}
                                <span class="status-badge status-completed" data-status="completed">
                                    <span class="status-icon">âœ“</span>
                                    <span class="status-label">ÎŸÎ»Î¿ÎºÎ»Î·ÏÏ‰Î¼Î­Î½Î·</span>
                                </span>
                                {% elif obl.status  ==  'overdue' %}
                                <span class="status-badge status-overdue" data-status="overdue">
                                    <span class="status-icon">âš ï¸</span>
                                    <span class="status-label">ÎšÎ±Î¸Ï…ÏƒÏ„ÎµÏÎ·Î¼Î­Î½Î·</span>
                                </span>
                                {% else %}
                                <span class="status-badge status-pending" data-status="pending">
                                    <span class="status-icon">â³</span>
                                    <span class="status-label">Î•ÎºÎºÏÎµÎ¼Î®Ï‚</span>
                                </span>
                                {% endif %}
                            </td>

                            <!-- Actions -->
                            <td class="col-actions center">
                                {% if obl.status != 'completed' %}
                                <button type="button"
                                        onclick="event.stopPropagation(); quickComplete({{ obl.id }});"
                                        class="btn btn-action btn-success btn-sm"
                                        title="Mark as completed">
                                    <span class="icon">âœ“</span>
                                    <span class="label">ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·</span>
                                </button>
                                {% else %}
                                <div class="completed-actions">
                                    <span class="completed-icon" title="Completed">âœ“</span>
                                    {% if obl.attachment %}
                                    <a href="{{ obl.attachment.url }}"
                                       target="_blank"
                                       onclick="event.stopPropagation();"
                                       class="attachment-link"
                                       title="Download attachment">
                                        ğŸ“
                                    </a>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        {% else %}
        <div class="empty-state">
            <div class="empty-icon">ğŸ“­</div>
            <div class="empty-content">
                <h3 class="empty-title">Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Ï…Ï€Î¿Ï‡ÏÎµÏÏƒÎµÎ¹Ï‚</h3>
                <p class="empty-description">Î”Î¿ÎºÎ¹Î¼Î¬ÏƒÏ„Îµ Î½Î± Î±Î»Î»Î¬Î¾ÎµÏ„Îµ Ï„Î± Ï†Î¯Î»Ï„ÏÎ± Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ·Ï‚</p>
                <button type="button" onclick="clearFilters()" class="btn btn-primary">
                    ğŸ”„ ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Î¦Î¯Î»Ï„ÏÏ‰Î½
                </button>
            </div>
        </div>
        {% endif %}

        <!-- TABLE FOOTER WITH PAGINATION INFO -->
        {% if upcoming %}
        <div class="table-footer">
            <div class="footer-info">
                <span>Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· <strong>{{ upcoming|length }}</strong> Î±Ï€ÏŒ <strong>{{ upcoming_count }}</strong> ÏƒÏ…Î½Î¿Î»Î¹ÎºÎ¬</span>
            </div>
        </div>
        {% endif %}
    </section>

</div>

<!-- SCRIPTS -->
<script src="{% static 'accounting/js/dashboard.js' %}"></script>
<script>
    // Initialize dashboard on load
    document.addEventListener('DOMContentLoaded', function () {
        console.log('âœ… Dashboard loaded');
        initializeFilterPresets();
    });

    // Filter preset buttons
    function initializeFilterPresets() {
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
        const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

        document.getElementById('filter-preset-today')?.addEventListener('click', () => {
            document.getElementById('filter-date-from').value = todayStr;
            document.getElementById('filter-date-to').value = todayStr;
            document.getElementById('filter-form').submit();
        });

        document.getElementById('filter-preset-week')?.addEventListener('click', () => {
            document.getElementById('filter-date-from').value = weekAgo;
            document.getElementById('filter-date-to').value = todayStr;
            document.getElementById('filter-form').submit();
        });

        document.getElementById('filter-preset-month')?.addEventListener('click', () => {
            document.getElementById('filter-date-from').value = monthAgo;
            document.getElementById('filter-date-to').value = todayStr;
            document.getElementById('filter-form').submit();
        });
    }

    // Bulk bar close
    function closeBulkBar() {
        document.getElementById('bulk-actions-bar').style.display = 'none';
    }

    // Table compact view toggle
    function toggleTableCompactView() {
        document.getElementById('obligations-table')?.classList.toggle('compact');
    }

    // Fullscreen toggle
    function toggleTableFullscreen() {
        document.querySelector('.table-container')?.classList.toggle('fullscreen');
    }
</script>

{% endblock %}