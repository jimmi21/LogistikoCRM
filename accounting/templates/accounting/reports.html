{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        text-align: center;
    }
    .stat-number {
        font-size: 36px;
        font-weight: bold;
        margin: 10px 0;
    }
    .chart-container {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 25px;
    }
</style>
{% endblock %}

{% block content %}
<div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
    <a href="/accounting/dashboard/" style="color: #667eea; text-decoration: none; font-weight: 600;">â† Î•Ï€Î¹ÏƒÏ„ÏÎ¿Ï†Î® ÏƒÏ„Î¿ Dashboard</a>
    <div>
        <a href="{% url 'accounting:calendar' %}" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 6px 14px; border-radius: 4px; text-decoration: none; font-weight: 600; margin-right: 8px;">ğŸ“… Calendar</a>
    </div>
</div>

<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 12px; color: white; margin-bottom: 30px;">
    <h1 style="margin: 0 0 10px 0;">ğŸ“Š Reports & Analytics</h1>
    <p style="margin: 0; opacity: 0.9;">Î‘Î½Î¬Î»Ï…ÏƒÎ· Î±Ï€ÏŒÎ´Î¿ÏƒÎ·Ï‚ ÎºÎ±Î¹ ÏƒÏ„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ¬</p>
</div>

<!-- PDF Export Section -->
<div class="chart-container" style="margin-bottom: 25px;">
    <h3 style="margin: 0 0 15px 0; color: #333;">ğŸ“¥ Î•Î¾Î±Î³Ï‰Î³Î® Î‘Î½Î±Ï†Î¿ÏÏÎ½ PDF</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
        <!-- Monthly Report Export -->
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef;">
            <h4 style="margin: 0 0 15px 0; color: #333;">ğŸ“… ÎœÎ·Î½Î¹Î±Î¯Î± Î‘Î½Î±Ï†Î¿ÏÎ¬</h4>
            <form id="monthly-report-form" style="display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end;">
                <div>
                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 5px;">ÎœÎ®Î½Î±Ï‚</label>
                    <select id="report-month" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        {% for m in "123456789101112"|make_list %}
                        {% if m == "1" %}
                        <option value="1" {% if current_month == 1 %}selected{% endif %}>Î™Î±Î½Î¿Ï…Î¬ÏÎ¹Î¿Ï‚</option>
                        {% elif m == "2" %}
                        <option value="2" {% if current_month == 2 %}selected{% endif %}>Î¦ÎµÎ²ÏÎ¿Ï…Î¬ÏÎ¹Î¿Ï‚</option>
                        {% elif m == "3" %}
                        <option value="3" {% if current_month == 3 %}selected{% endif %}>ÎœÎ¬ÏÏ„Î¹Î¿Ï‚</option>
                        {% elif m == "4" %}
                        <option value="4" {% if current_month == 4 %}selected{% endif %}>Î‘Ï€ÏÎ¯Î»Î¹Î¿Ï‚</option>
                        {% elif m == "5" %}
                        <option value="5" {% if current_month == 5 %}selected{% endif %}>ÎœÎ¬Î¹Î¿Ï‚</option>
                        {% elif m == "6" %}
                        <option value="6" {% if current_month == 6 %}selected{% endif %}>Î™Î¿ÏÎ½Î¹Î¿Ï‚</option>
                        {% elif m == "7" %}
                        <option value="7" {% if current_month == 7 %}selected{% endif %}>Î™Î¿ÏÎ»Î¹Î¿Ï‚</option>
                        {% elif m == "8" %}
                        <option value="8" {% if current_month == 8 %}selected{% endif %}>Î‘ÏÎ³Î¿Ï…ÏƒÏ„Î¿Ï‚</option>
                        {% elif m == "9" %}
                        <option value="9" {% if current_month == 9 %}selected{% endif %}>Î£ÎµÏ€Ï„Î­Î¼Î²ÏÎ¹Î¿Ï‚</option>
                        {% elif m == "10" %}
                        <option value="10" {% if current_month == 10 %}selected{% endif %}>ÎŸÎºÏ„ÏÎ²ÏÎ¹Î¿Ï‚</option>
                        {% elif m == "11" %}
                        <option value="11" {% if current_month == 11 %}selected{% endif %}>ÎÎ¿Î­Î¼Î²ÏÎ¹Î¿Ï‚</option>
                        {% elif m == "12" %}
                        <option value="12" {% if current_month == 12 %}selected{% endif %}>Î”ÎµÎºÎ­Î¼Î²ÏÎ¹Î¿Ï‚</option>
                        {% endif %}
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 5px;">ÎˆÏ„Î¿Ï‚</label>
                    <select id="report-year" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        {% for y in year_choices %}
                        <option value="{{ y }}" {% if y == current_year %}selected{% endif %}>{{ y }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button type="button" onclick="downloadMonthlyReport()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: 600;">
                    ğŸ“¥ Î›Î®ÏˆÎ· PDF
                </button>
            </form>
        </div>

        <!-- Client Report Export -->
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef;">
            <h4 style="margin: 0 0 15px 0; color: #333;">ğŸ‘¤ Î‘Î½Î±Ï†Î¿ÏÎ¬ Î ÎµÎ»Î¬Ï„Î·</h4>
            <form id="client-report-form" style="display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end;">
                <div style="flex: 1; min-width: 200px;">
                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 5px;">Î ÎµÎ»Î¬Ï„Î·Ï‚</label>
                    <select id="report-client" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        <option value="">-- Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Î ÎµÎ»Î¬Ï„Î· --</option>
                        {% for client in clients %}
                        <option value="{{ client.id }}">{{ client.eponimia }} ({{ client.afm }})</option>
                        {% endfor %}
                    </select>
                </div>
                <button type="button" onclick="downloadClientReport()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: 600;">
                    ğŸ“¥ Î›Î®ÏˆÎ· PDF
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Current Month Summary -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
    <div class="stat-card" style="border-top: 4px solid #667eea;">
        <div style="color: #666; font-size: 14px;">Î¤ÏÎ­Ï‡Ï‰Î½ ÎœÎ®Î½Î±Ï‚ - Î£ÏÎ½Î¿Î»Î¿</div>
        <div class="stat-number" style="color: #667eea;">{{ current_stats.total }}</div>
    </div>
    
    <div class="stat-card" style="border-top: 4px solid #28a745;">
        <div style="color: #666; font-size: 14px;">ÎŸÎ»Î¿ÎºÎ»Î·ÏÏ‰Î¼Î­Î½ÎµÏ‚</div>
        <div class="stat-number" style="color: #28a745;">{{ current_stats.completed }}</div>
    </div>
    
    <div class="stat-card" style="border-top: 4px solid #ffc107;">
        <div style="color: #666; font-size: 14px;">Î•ÎºÎºÏÎµÎ¼ÎµÎ¯Ï‚</div>
        <div class="stat-number" style="color: #ffc107;">{{ current_stats.pending }}</div>
    </div>
    
    <div class="stat-card" style="border-top: 4px solid #dc3545;">
        <div style="color: #666; font-size: 14px;">ÎšÎ±Î¸Ï…ÏƒÏ„ÎµÏÎ·Î¼Î­Î½ÎµÏ‚</div>
        <div class="stat-number" style="color: #dc3545;">{{ current_stats.overdue }}</div>
    </div>
</div>

<!-- Monthly Trend Chart -->
<div class="chart-container">
    <h3 style="margin: 0 0 20px 0; color: #333;">ğŸ“ˆ ÎœÎ·Î½Î¹Î±Î¯Î± Î•Î¾Î­Î»Î¹Î¾Î· ({{ months_back }} Î¼Î®Î½ÎµÏ‚)</h3>
    <canvas id="monthlyChart" height="80"></canvas>
</div>

<!-- Time & Revenue Stats -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
    <div class="chart-container">
        <h3 style="margin: 0 0 15px 0; color: #333;">â±ï¸ Time Tracking</h3>
        <div style="text-align: center;">
            <div style="font-size: 48px; font-weight: bold; color: #667eea; margin: 20px 0;">
                {{ time_stats.total_hours|floatformat:1|default:"0" }}h
            </div>
            <div style="color: #666; margin-bottom: 10px;">Î£Ï…Î½Î¿Î»Î¹ÎºÎ­Ï‚ ÎÏÎµÏ‚</div>
            <div style="color: #999; font-size: 14px;">
                ÎœÎ­ÏƒÎ¿Ï‚ ÏŒÏÎ¿Ï‚: {{ time_stats.avg_hours|floatformat:1|default:"0" }}h Î±Î½Î¬ task
            </div>
            <div style="color: #999; font-size: 14px;">
                Î£ÏÎ½Î¿Î»Î¿ tasks: {{ time_stats.total_tasks }}
            </div>
        </div>
    </div>
    
    <div class="chart-container">
        <h3 style="margin: 0 0 15px 0; color: #333;">ğŸ’° Revenue</h3>
        <div style="text-align: center;">
            <div style="font-size: 48px; font-weight: bold; color: #28a745; margin: 20px 0;">
                â‚¬{{ total_revenue|floatformat:2 }}
            </div>
            <div style="color: #666; margin-bottom: 10px;">Î£Ï…Î½Î¿Î»Î¹ÎºÎ¬ ÎˆÏƒÎ¿Î´Î±</div>
            <div style="color: #999; font-size: 14px;">
                Î’Î¬ÏƒÎµÎ¹ time tracking
            </div>
        </div>
    </div>
</div>

<!-- Top Clients -->
<div class="chart-container">
    <h3 style="margin: 0 0 20px 0; color: #333;">ğŸ‘¥ Top 10 Clients</h3>
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                <th style="padding: 12px; text-align: left;">Î ÎµÎ»Î¬Ï„Î·Ï‚</th>
                <th style="padding: 12px; text-align: center;">Î£ÏÎ½Î¿Î»Î¿</th>
                <th style="padding: 12px; text-align: center;">ÎŸÎ»Î¿ÎºÎ».</th>
                <th style="padding: 12px; text-align: center;">Completion %</th>
                <th style="padding: 12px; text-align: center;">ÎÏÎµÏ‚</th>
            </tr>
        </thead>
        <tbody>
            {% for client in client_stats %}
            <tr style="border-bottom: 1px solid #e9ecef;">
                <td style="padding: 12px;">
                    <a href="{% url 'accounting:client_detail' client.client__id %}" style="color: #667eea; text-decoration: none; font-weight: 500;">
                        {{ client.client__eponimia }}
                    </a>
                </td>
                <td style="padding: 12px; text-align: center;">{{ client.total }}</td>
                <td style="padding: 12px; text-align: center; color: #28a745; font-weight: 600;">{{ client.completed }}</td>
                <td style="padding: 12px; text-align: center;">
                    <div style="background: #f0f8ff; padding: 4px 8px; border-radius: 4px; display: inline-block;">
                        {{ client.completion_rate|floatformat:0 }}%
                    </div>
                </td>
                <td style="padding: 12px; text-align: center;">{{ client.total_time|floatformat:1|default:"â€”" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Obligation Types Stats -->
<div class="chart-container">
    <h3 style="margin: 0 0 20px 0; color: #333;">ğŸ“‹ Top Î¥Ï€Î¿Ï‡ÏÎµÏÏƒÎµÎ¹Ï‚</h3>
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                <th style="padding: 12px; text-align: left;">Î¤ÏÏ€Î¿Ï‚</th>
                <th style="padding: 12px; text-align: center;">Î£ÏÎ½Î¿Î»Î¿</th>
                <th style="padding: 12px; text-align: center;">ÎŸÎ»Î¿ÎºÎ».</th>
                <th style="padding: 12px; text-align: center;">Îœ.ÎŸ. Î§ÏÏŒÎ½Î¿Ï‚</th>
            </tr>
        </thead>
        <tbody>
            {% for type in type_stats %}
            <tr style="border-bottom: 1px solid #e9ecef;">
                <td style="padding: 12px; font-weight: 500;">{{ type.obligation_type__name }}</td>
                <td style="padding: 12px; text-align: center;">{{ type.total }}</td>
                <td style="padding: 12px; text-align: center; color: #28a745;">{{ type.completed }}</td>
                <td style="padding: 12px; text-align: center;">{{ type.avg_time|floatformat:1|default:"â€”" }}h</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
// PDF Download Functions
function downloadMonthlyReport() {
    const month = document.getElementById('report-month').value;
    const year = document.getElementById('report-year').value;
    if (month && year) {
        window.open(`/accounting/reports/monthly/${year}/${month}/pdf/`, '_blank');
    } else {
        alert('Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÏ€Î¹Î»Î­Î¾Ï„Îµ Î¼Î®Î½Î± ÎºÎ±Î¹ Î­Ï„Î¿Ï‚.');
    }
}

function downloadClientReport() {
    const clientId = document.getElementById('report-client').value;
    if (clientId) {
        window.open(`/accounting/reports/client/${clientId}/pdf/`, '_blank');
    } else {
        alert('Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÏ€Î¹Î»Î­Î¾Ï„Îµ Ï€ÎµÎ»Î¬Ï„Î·.');
    }
}

// Monthly Trend Chart
const ctx = document.getElementById('monthlyChart').getContext('2d');
new Chart(ctx, {
    type: 'line',
    data: {
        labels: {{ chart_labels_json|safe }},
        datasets: [{
            label: 'ÎŸÎ»Î¿ÎºÎ»Î·ÏÏ‰Î¼Î­Î½ÎµÏ‚',
            data: {{ chart_completed_json|safe }},
            borderColor: '#28a745',
            backgroundColor: 'rgba(40, 167, 69, 0.1)',
            tension: 0.4,
            fill: true
        }, {
            label: 'Î•ÎºÎºÏÎµÎ¼ÎµÎ¯Ï‚',
            data: {{ chart_pending_json|safe }},
            borderColor: '#ffc107',
            backgroundColor: 'rgba(255, 193, 7, 0.1)',
            tension: 0.4,
            fill: true
        }, {
            label: 'ÎšÎ±Î¸Ï…ÏƒÏ„ÎµÏÎ·Î¼Î­Î½ÎµÏ‚',
            data: {{ chart_overdue_json|safe }},
            borderColor: '#dc3545',
            backgroundColor: 'rgba(220, 53, 69, 0.1)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'top',
            }
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});
</script>

{% endblock %}