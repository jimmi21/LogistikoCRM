{% extends "reports/base_report.html" %}

{% block title %}Μηνιαία Αναφορά - {{ month_name }} {{ year }}{% endblock %}

{% block content %}
<div class="header">
    <h1>Μηνιαία Αναφορά Υποχρεώσεων</h1>
    <p class="subtitle">{{ month_name }} {{ year }}</p>
</div>

<!-- Statistics -->
<div class="stats-container">
    <div class="stat-box">
        <div class="stat-label">Σύνολο</div>
        <div class="stat-number">{{ stats.total }}</div>
    </div>
    <div class="stat-box">
        <div class="stat-label">Ολοκληρωμένες</div>
        <div class="stat-number completed">{{ stats.completed }}</div>
    </div>
    <div class="stat-box">
        <div class="stat-label">Εκκρεμείς</div>
        <div class="stat-number pending">{{ stats.pending }}</div>
    </div>
    <div class="stat-box">
        <div class="stat-label">Καθυστερημένες</div>
        <div class="stat-number overdue">{{ stats.overdue }}</div>
    </div>
</div>

<!-- Summary Bar -->
<div class="no-break" style="padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <strong>Περίοδος:</strong> {{ month|stringformat:"02d" }}/{{ year }}
        </div>
        <div>
            <strong>Ποσοστό Ολοκλήρωσης:</strong>
            <span style="color: {% if stats.completion_rate >= 80 %}#28a745{% elif stats.completion_rate >= 50 %}#ffc107{% else %}#dc3545{% endif %}; font-weight: bold;">
                {{ stats.completion_rate }}%
            </span>
        </div>
    </div>
</div>

{% if by_status.overdue %}
<!-- Overdue Section -->
<h2 style="color: #dc3545; border-color: #dc3545;">Καθυστερημένες Υποχρεώσεις ({{ by_status.overdue|length }})</h2>
<table>
    <thead>
        <tr>
            <th style="width: 30%;">Πελάτης</th>
            <th style="width: 15%;">ΑΦΜ</th>
            <th style="width: 25%;">Τύπος</th>
            <th style="width: 15%;">Προθεσμία</th>
            <th style="width: 15%;">Ημέρες</th>
        </tr>
    </thead>
    <tbody>
        {% for ob in by_status.overdue %}
        <tr style="background: #fff5f5;">
            <td><strong>{{ ob.client.eponimia }}</strong></td>
            <td>{{ ob.client.afm }}</td>
            <td>{{ ob.obligation_type.name }}</td>
            <td>{{ ob.deadline|date:"d/m/Y" }}</td>
            <td style="color: #dc3545; font-weight: bold;">{{ ob.days_until_deadline }} ημ.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}

{% if by_status.pending %}
<!-- Pending Section -->
<h2 style="color: #856404; border-color: #ffc107;">Εκκρεμείς Υποχρεώσεις ({{ by_status.pending|length }})</h2>
<table>
    <thead>
        <tr>
            <th style="width: 30%;">Πελάτης</th>
            <th style="width: 15%;">ΑΦΜ</th>
            <th style="width: 25%;">Τύπος</th>
            <th style="width: 15%;">Προθεσμία</th>
            <th style="width: 15%;">Υπολ. Ημέρες</th>
        </tr>
    </thead>
    <tbody>
        {% for ob in by_status.pending %}
        <tr>
            <td><strong>{{ ob.client.eponimia }}</strong></td>
            <td>{{ ob.client.afm }}</td>
            <td>{{ ob.obligation_type.name }}</td>
            <td>{{ ob.deadline|date:"d/m/Y" }}</td>
            <td>
                {% if ob.days_until_deadline <= 3 %}
                <span style="color: #dc3545; font-weight: bold;">{{ ob.days_until_deadline }} ημ.</span>
                {% elif ob.days_until_deadline <= 7 %}
                <span style="color: #ffc107; font-weight: bold;">{{ ob.days_until_deadline }} ημ.</span>
                {% else %}
                {{ ob.days_until_deadline }} ημ.
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}

{% if by_status.completed %}
<!-- Completed Section -->
<h2 style="color: #155724; border-color: #28a745;">Ολοκληρωμένες Υποχρεώσεις ({{ by_status.completed|length }})</h2>
<table>
    <thead>
        <tr>
            <th style="width: 30%;">Πελάτης</th>
            <th style="width: 15%;">ΑΦΜ</th>
            <th style="width: 25%;">Τύπος</th>
            <th style="width: 15%;">Προθεσμία</th>
            <th style="width: 15%;">Ολοκλήρωση</th>
        </tr>
    </thead>
    <tbody>
        {% for ob in by_status.completed %}
        <tr style="background: #f8fff8;">
            <td>{{ ob.client.eponimia }}</td>
            <td>{{ ob.client.afm }}</td>
            <td>{{ ob.obligation_type.name }}</td>
            <td>{{ ob.deadline|date:"d/m/Y" }}</td>
            <td>
                {% if ob.completed_date %}
                {{ ob.completed_date|date:"d/m/Y" }}
                {% else %}
                —
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}

{% if not obligations %}
<div style="text-align: center; padding: 40px; color: #666;">
    <p style="font-size: 14pt;">Δεν υπάρχουν υποχρεώσεις για αυτήν την περίοδο.</p>
</div>
{% endif %}

<!-- Summary -->
<div class="page-break"></div>
<h2>Συνοπτική Αναφορά</h2>
<table>
    <thead>
        <tr>
            <th>Κατάσταση</th>
            <th style="text-align: center;">Πλήθος</th>
            <th style="text-align: center;">Ποσοστό</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><span class="status-badge status-completed">Ολοκληρωμένες</span></td>
            <td style="text-align: center;">{{ stats.completed }}</td>
            <td style="text-align: center;">{% widthratio stats.completed stats.total 100 %}%</td>
        </tr>
        <tr>
            <td><span class="status-badge status-pending">Εκκρεμείς</span></td>
            <td style="text-align: center;">{{ stats.pending }}</td>
            <td style="text-align: center;">{% widthratio stats.pending stats.total 100 %}%</td>
        </tr>
        <tr>
            <td><span class="status-badge status-overdue">Καθυστερημένες</span></td>
            <td style="text-align: center;">{{ stats.overdue }}</td>
            <td style="text-align: center;">{% widthratio stats.overdue stats.total 100 %}%</td>
        </tr>
        <tr style="font-weight: bold; background: #f5f5f5;">
            <td>Σύνολο</td>
            <td style="text-align: center;">{{ stats.total }}</td>
            <td style="text-align: center;">100%</td>
        </tr>
    </tbody>
</table>
{% endblock %}
