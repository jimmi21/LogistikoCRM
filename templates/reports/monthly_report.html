{% extends "reports/base_report.html" %}

{% block title %}Μηνιαία Αναφορά - {{ month_name }} {{ year }}{% endblock %}

{% block content %}
<div class="header">
    <h1>Μηνιαία Αναφορά Υποχρεώσεων</h1>
    <p class="subtitle">{{ month_name }} {{ year }}</p>
</div>

<!-- Statistics -->
<table class="stats-table">
    <tr>
        <td>
            <div class="stat-label">Σύνολο</div>
            <div class="stat-number">{{ stats.total }}</div>
        </td>
        <td>
            <div class="stat-label">Ολοκληρωμένες</div>
            <div class="stat-number stat-number-completed">{{ stats.completed }}</div>
        </td>
        <td>
            <div class="stat-label">Εκκρεμείς</div>
            <div class="stat-number stat-number-pending">{{ stats.pending }}</div>
        </td>
        <td>
            <div class="stat-label">Καθυστερημένες</div>
            <div class="stat-number stat-number-overdue">{{ stats.overdue }}</div>
        </td>
    </tr>
</table>

<!-- Summary Bar -->
<table style="background-color: #f8f9fa; margin-bottom: 20px;">
    <tr>
        <td style="padding: 15px; width: 50%;">
            <strong>Περίοδος:</strong> {{ month|stringformat:"02d" }}/{{ year }}
        </td>
        <td style="padding: 15px; width: 50%; text-align: right;">
            <strong>Ποσοστό Ολοκλήρωσης:</strong>
            <span class="font-bold {% if stats.completion_rate >= 80 %}text-success{% elif stats.completion_rate >= 50 %}text-warning{% else %}text-danger{% endif %}">
                {{ stats.completion_rate }}%
            </span>
        </td>
    </tr>
</table>

{% if by_status.overdue %}
<!-- Overdue Section -->
<h2 style="color: #dc3545; border-color: #dc3545;">Καθυστερημένες Υποχρεώσεις ({{ by_status.overdue|length }})</h2>
<table>
    <thead>
        <tr>
            <th style="width: 30%;">Πελάτης</th>
            <th style="width: 15%;">ΑΦΜ</th>
            <th style="width: 25%;">Τύπος</th>
            <th style="width: 15%;">Προθεσμία</th>
            <th style="width: 15%;">Ημέρες</th>
        </tr>
    </thead>
    <tbody>
        {% for ob in by_status.overdue %}
        <tr class="row-overdue">
            <td class="font-bold">{{ ob.client.eponimia }}</td>
            <td>{{ ob.client.afm }}</td>
            <td>{{ ob.obligation_type.name }}</td>
            <td>{{ ob.deadline|date:"d/m/Y" }}</td>
            <td class="text-danger font-bold">{{ ob.days_until_deadline }} ημ.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}

{% if by_status.pending %}
<!-- Pending Section -->
<h2 style="color: #856404; border-color: #ffc107;">Εκκρεμείς Υποχρεώσεις ({{ by_status.pending|length }})</h2>
<table>
    <thead>
        <tr>
            <th style="width: 30%;">Πελάτης</th>
            <th style="width: 15%;">ΑΦΜ</th>
            <th style="width: 25%;">Τύπος</th>
            <th style="width: 15%;">Προθεσμία</th>
            <th style="width: 15%;">Υπολ. Ημέρες</th>
        </tr>
    </thead>
    <tbody>
        {% for ob in by_status.pending %}
        <tr class="{% cycle 'row-light' 'row-dark' %}">
            <td class="font-bold">{{ ob.client.eponimia }}</td>
            <td>{{ ob.client.afm }}</td>
            <td>{{ ob.obligation_type.name }}</td>
            <td>{{ ob.deadline|date:"d/m/Y" }}</td>
            <td>
                {% if ob.days_until_deadline <= 3 %}
                <span class="text-danger font-bold">{{ ob.days_until_deadline }} ημ.</span>
                {% elif ob.days_until_deadline <= 7 %}
                <span class="text-warning font-bold">{{ ob.days_until_deadline }} ημ.</span>
                {% else %}
                {{ ob.days_until_deadline }} ημ.
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}

{% if by_status.completed %}
<!-- Completed Section -->
<h2 style="color: #155724; border-color: #28a745;">Ολοκληρωμένες Υποχρεώσεις ({{ by_status.completed|length }})</h2>
<table>
    <thead>
        <tr>
            <th style="width: 30%;">Πελάτης</th>
            <th style="width: 15%;">ΑΦΜ</th>
            <th style="width: 25%;">Τύπος</th>
            <th style="width: 15%;">Προθεσμία</th>
            <th style="width: 15%;">Ολοκλήρωση</th>
        </tr>
    </thead>
    <tbody>
        {% for ob in by_status.completed %}
        <tr class="row-completed">
            <td>{{ ob.client.eponimia }}</td>
            <td>{{ ob.client.afm }}</td>
            <td>{{ ob.obligation_type.name }}</td>
            <td>{{ ob.deadline|date:"d/m/Y" }}</td>
            <td>
                {% if ob.completed_date %}
                {{ ob.completed_date|date:"d/m/Y" }}
                {% else %}
                —
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}

{% if not obligations %}
<p style="text-align: center; padding: 40px; color: #666666; font-size: 14pt;">
    Δεν υπάρχουν υποχρεώσεις για αυτήν την περίοδο.
</p>
{% endif %}

<!-- Summary -->
<h2>Συνοπτική Αναφορά</h2>
<table>
    <thead>
        <tr>
            <th>Κατάσταση</th>
            <th class="text-center">Πλήθος</th>
            <th class="text-center">Ποσοστό</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><span class="status-badge status-completed">Ολοκληρωμένες</span></td>
            <td class="text-center">{{ stats.completed }}</td>
            <td class="text-center">{% widthratio stats.completed stats.total 100 %}%</td>
        </tr>
        <tr>
            <td><span class="status-badge status-pending">Εκκρεμείς</span></td>
            <td class="text-center">{{ stats.pending }}</td>
            <td class="text-center">{% widthratio stats.pending stats.total 100 %}%</td>
        </tr>
        <tr>
            <td><span class="status-badge status-overdue">Καθυστερημένες</span></td>
            <td class="text-center">{{ stats.overdue }}</td>
            <td class="text-center">{% widthratio stats.overdue stats.total 100 %}%</td>
        </tr>
        <tr style="font-weight: bold; background-color: #f5f5f5;">
            <td>Σύνολο</td>
            <td class="text-center">{{ stats.total }}</td>
            <td class="text-center">100%</td>
        </tr>
    </tbody>
</table>
{% endblock %}
